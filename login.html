<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Iniciar Sesión | Catálogo de Películas y Series</title>
    <link rel="manifest" href="manifest.json">
    <script src="auth.js"></script>
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#121212">

    <script>
        if ('serviceWorker' in navigator) {

      window.addEventListener('load', () => {

        navigator.serviceWorker.register('sw.js');

      });

    }

    </script>
</head>

<body>

    <div class="container">

        <h1>Iniciar Sesión</h1>

        <input type="text" id="username" placeholder="Usuario" autocomplete="username" />

        <input type="password" id="password" placeholder="Contraseña" autocomplete="current-password" />

        <button class="btn" onclick="login()">Entrar</button>

        <div id="message"></div>

        <p style="margin-top: 20px; color: #ccc;">

            ¿No tienes cuenta? <a href="register.html" style="color:#e50914; text-decoration:none;">Regístrate aquí</a>

        </p>

    </div>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>

    if(localStorage.getItem("loggedInUser")) {

      window.location.href = "dash.html";

    }

    function login() {

      const username = document.getElementById("username").value.trim();

      const password = document.getElementById("password").value;

      const message = document.getElementById("message");

      message.style.color = "#ff4444";

      if (!username && !password) {

        message.textContent = "Por favor, ingresa tu usuario y contraseña.";

        return;

      }

      if (!username) {

        message.textContent = "El campo de usuario está vacío.";

        return;

      }

      if (!password) {

        message.textContent = "El campo de contraseña está vacío.";

        return;

      }

  fetch('https://api.ultrafilm.online/login', {

        method: 'POST',

        headers: { 'Content-Type': 'application/json' },

        body: JSON.stringify({ username, password })

      })

      .then(res => res.json())

      .then(data => {

        if (data.ok && data.user) {

          localStorage.setItem("loggedInUser", JSON.stringify(data.user));

          localStorage.setItem("jwt", data.token);

          if (data.user.role === 'admin') {

            localStorage.setItem("adminToken", data.token);

          } else {

            localStorage.removeItem("adminToken");

          }

          if (!data.user.is_verified) {

            showToast('Inicio de sesión correcto. Tu correo no está verificado — revisa tu bandeja o utiliza el botón para reenviar.', 'info', 6000);

          }

          window.location.replace("dash.html");

        } else {

          if (data && data.error) {

            if (data.error.includes('Datos incompletos')) {

              message.textContent = "Debes completar usuario y contraseña.";

            } else if (data.error.includes('Usuario o contraseña incorrectos')) {

              message.textContent = "Usuario o contraseña incorrectos.";

            } else {

              message.textContent = data.error;

            }

          } else {

            message.textContent = "Error de autenticación.";

          }

        }

      })

      .catch(() => {

        message.textContent = "Error de conexión con el servidor.";

      });

    }

    function showToast(message, type = 'info', duration = 3500) {

      const container = document.getElementById('toast-container');

      const toast = document.createElement('div');

      toast.className = `toast toast-${type}`;

      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => {

        toast.classList.add('hide');

        toast.addEventListener('transitionend', () => toast.remove());

      }, duration);

    }

    async function safeFetch(url, options = {}) {

      try {

        const res = await fetch(url, options);

        if (!res.ok) {

          let errMsg = `Error ${res.status}`;

          try {

            const data = await res.json();

            errMsg = data.error || errMsg;

          } catch {}

          throw new Error(errMsg);

        }

        return await res.json();

      } catch (err) {

        showToast(err.message || 'Error de conexión con el servidor.', 'error');

        throw err;

      }

    }

    </script>

</body>

</html>