<!DOCTYPE html>

<html lang="es">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Hub - UltraFilm</title>

  <link rel="stylesheet" href="style.css" />

  <link rel="manifest" href="manifest.json">

  <style>

    body {

      background-color: #121212;

      color: #eee;

      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

      margin: 0;

    }

    header {

      text-align: center;

      padding: 20px 10px;

      background-color: #1c1c1c;

      color: #e50914;

      font-weight: bold;

      font-size: 1.8rem;

    }

    main {

      max-width: 600px;

      margin: 40px auto;

      padding: 20px;

      background-color: #1c1c1c;

      border-radius: 10px;

      box-shadow: 0 0 15px rgba(229, 9, 20, 0.7);

      text-align: center;

    }

    main h2 {

      margin-bottom: 30px;

      color: #e50914;

    }

    main button, main a.button-link {

      display: block;

      width: 100%;

      max-width: 300px;

      margin: 10px auto;

      padding: 12px 0;

      font-size: 1.2rem;

      font-weight: bold;

      color: #fff;

      background-color: #e50914;

      border: none;

      border-radius: 8px;

      cursor: pointer;

      text-decoration: none;

      transition: background-color 0.3s ease;

    }

    main button:hover, main a.button-link:hover {

      background-color: #b20710;

    }

    nav a[href="guardados.html"]:hover {

      background-color: #e50914 !important;

      color: #fff !important;

    }

    footer {

      text-align: center;

      padding: 20px 10px;

      background-color: #1c1c1c;

      color: #666;

      font-size: 0.9rem;

      margin-top: 80px;

    }

    #toast-container {

      position: fixed;

      top: 30px;

      right: 30px;

      z-index: 99999;

      display: flex;

      flex-direction: column;

      gap: 12px;

      pointer-events: none;

    }

    .toast {

      min-width: 220px;

      max-width: 350px;

      background: #232323;

      color: #fff;

      padding: 16px 24px;

      border-radius: 8px;

      font-size: 1rem;

      box-shadow: 0 2px 12px rgba(229,9,20,0.18);

      opacity: 0.97;

      pointer-events: auto;

      transition: opacity 0.3s, transform 0.3s;

      animation: toastIn 0.3s;

    }

    .toast-success { background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); color: #222; }

    .toast-error { background: linear-gradient(90deg, #e50914 60%, #b20710 100%); color: #fff; }

    .toast-info { background: linear-gradient(90deg, #232526 0%, #414345 100%); color: #fff; }

    .toast.hide {

      opacity: 0;

      transform: translateY(-20px) scale(0.98);

      transition: opacity 0.3s, transform 0.3s;

    }

    @keyframes toastIn {

      from { opacity: 0; transform: translateY(-20px) scale(0.98); }

      to { opacity: 0.97; transform: none; }

    }

    @keyframes favAdd {

      from { background: #43e97b33; }

      to { background: none; }

    }

    @keyframes favRemove {

      from { opacity: 1; transform: scale(1); }

      to { opacity: 0; transform: scale(0.95); }

    }

    .fav-added {

      animation: favAdd 0.6s;

    }

    .fav-removed {

      animation: favRemove 0.4s forwards;

    }

    .modal-fade {

      opacity: 0;

      transform: scale(0.98) translateY(30px);

      transition: opacity 0.35s cubic-bezier(.4,0,.2,1), transform 0.35s cubic-bezier(.4,0,.2,1);

      pointer-events: none;

    }

    .modal-fade.active {

      opacity: 1;

      transform: scale(1) translateY(0);

      pointer-events: auto;

    }

  </style>

  <script>

    if ('serviceWorker' in navigator) {

      navigator.serviceWorker.register('sw.js');

    }

  </script>

</head>

<body>

  <header>

  <h1>ðŸŽ¬ UltraFilm</h1>

  </header>

  <main>

    <h2>Bienvenido, <span id="usuario-nombre"></span></h2>

    <!-- Banner para usuarios no verificados -->

    <div id="verify-banner" style="display:none;background:#3a2a2a;border:1px solid #e09b9b;padding:12px;border-radius:8px;margin:12px 0;color:#fff;">

      <strong>Tu correo electrÃ³nico no estÃ¡ verificado.</strong>

      <p style="margin:8px 0 0 0;color:#ddd;">Revisa tu bandeja (o la carpeta de spam). Si no recibiste el email, puedes reenviarlo ahora.</p>

      <div style="margin-top:10px;display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;">

        <button id="resend-verify-btn" style="background:#444;color:#fff;padding:8px 14px;border-radius:6px;border:none;cursor:pointer;">Reenviar email de verificaciÃ³n</button>

        <button id="dismiss-verify-btn" style="background:transparent;border:1px solid #666;color:#fff;padding:8px 14px;border-radius:6px;cursor:pointer;">Recordar despuÃ©s</button>

      </div>

    </div>

    <a href="peliculas.html" class="button-link">PelÃ­culas</a>

    <a href="series.html" class="button-link">Series</a>

    <a href="favoritos.html" class="button-link">Favoritos</a>

    <a href="guardados.html" class="button-link">Guardados</a>

    <a href="manage.html" class="button-link">Gestionar cuenta</a>

    <button id="logout-btn">Cerrar sesiÃ³n</button>

  </main>

  <div id="logout-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);z-index:10000;align-items:center;justify-content:center;">

    <div style="background:#232323;padding:32px 24px 20px 24px;border-radius:10px;box-shadow:0 4px 32px #000a;max-width:90vw;width:340px;text-align:center;">

      <h3 style="color:#e50914;margin-top:0;">Â¿Cerrar sesiÃ³n?</h3>

      <p style="color:#eee;margin-bottom:24px;">Â¿Seguro que quieres cerrar sesiÃ³n?</p>

      <button id="cancel-logout-btn" style="margin-right:12px;padding:10px 22px;border-radius:6px;border:none;background:#444;color:#fff;font-weight:bold;cursor:pointer;">Cancelar</button>

      <button id="confirm-logout-btn" style="padding:10px 22px;border-radius:6px;border:none;background:#e50914;color:#fff;font-weight:bold;cursor:pointer;">Cerrar sesiÃ³n</button>

    </div>

  </div>

  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <footer>

  Â© 2025 UltraFilm Cine & Series. Todos los derechos reservados.

  </footer>

  <script>

    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

    if (!loggedInUser || !loggedInUser.username) {

      window.location.href = "login.html";

    } else {

      document.getElementById('usuario-nombre').textContent = loggedInUser.username;

    }

    document.getElementById('logout-btn').addEventListener('click', () => {

      const modal = document.getElementById('logout-modal');

      modal.style.display = 'flex';

      setTimeout(() => document.getElementById('cancel-logout-btn').focus(), 50);

    });

    document.getElementById('cancel-logout-btn').addEventListener('click', () => {

      document.getElementById('logout-modal').style.display = 'none';

    });

    document.getElementById('confirm-logout-btn').addEventListener('click', () => {

      localStorage.removeItem("loggedInUser");

      window.location.href = "index.html";

    });

    document.getElementById('logout-modal').addEventListener('keydown', (e) => {

      if (e.key === 'Escape') {

        document.getElementById('logout-modal').style.display = 'none';

      }

    });

    function showToast(message, type = 'info', duration = 3500) {

      const container = document.getElementById('toast-container');

      const toast = document.createElement('div');

      toast.className = `toast toast-${type}`;

      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => {

        toast.classList.add('hide');

        toast.addEventListener('transitionend', () => toast.remove());

      }, duration);

    }

    async function safeFetch(url, options = {}) {

      try {

        const res = await fetch(url, options);

        if (!res.ok) {

          let errMsg = `Error ${res.status}`;

          try {

            const data = await res.json();

            errMsg = data.error || errMsg;

          } catch {}

          throw new Error(errMsg);

        }

        return await res.json();

      } catch (err) {

        showToast(err.message || 'Error de conexiÃ³n con el servidor.', 'error');

        throw err;

      }

    }

(function handleVerificationBanner() {
  try {
    const banner = document.getElementById('verify-banner');

    if (!banner) {
      return;
    }

    const token = localStorage.getItem('jwt');

    if (!token) {
      banner.style.display = 'none';
      return;
    }

    let bannerDismissed = localStorage.getItem('verify-banner-dismissed') === 'true';

    function updateBanner(userData) {
      const user = userData || loggedInUser;

      if (user && !user.is_verified && !bannerDismissed) {
        banner.style.display = 'block';
      } else {
        banner.style.display = 'none';
      }
    }

    (async function loadInitialState() {
      try {
        const response = await safeFetch('https://api.ultrafilm.online/user', {
          method: 'GET',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response && response.user) {
          const updatedUser = { ...loggedInUser, is_verified: response.user.is_verified };
          localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
          updateBanner(response.user);
        }
      } catch (e) {
        updateBanner(loggedInUser);
      }
    })();

    const resendBtn = document.getElementById('resend-verify-btn');
    if (resendBtn) {
      resendBtn.addEventListener('click', async () => {
        resendBtn.disabled = true;
        resendBtn.textContent = 'Enviando...';

        try {
          await safeFetch('https://api.ultrafilm.online/resend-verification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: loggedInUser.email })
          });

          showToast('Email de verificaciÃ³n reenviado. Revisa tu bandeja (incluido spam).', 'success', 6000);
        } catch (e) {
          console.error('Error reenviando verificaciÃ³n:', e);
        } finally {
          resendBtn.disabled = false;
          resendBtn.textContent = 'Reenviar email de verificaciÃ³n';
        }
      });
    }

    const dismissBtn = document.getElementById('dismiss-verify-btn');
    if (dismissBtn) {
      dismissBtn.addEventListener('click', () => {
        banner.style.display = 'none';
        bannerDismissed = true;
        localStorage.setItem('verify-banner-dismissed', 'true');
      });
    }

    setInterval(async () => {
      const currentToken = localStorage.getItem('jwt');
      if (!currentToken) {
        return;
      }

      try {
        const response = await safeFetch('https://api.ultrafilm.online/user', {
          method: 'GET',
          headers: { 
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (response && response.user) {
          const storedUser = JSON.parse(localStorage.getItem('loggedInUser'));
          const wasUnverified = !storedUser.is_verified;

          const updatedUser = { ...storedUser, is_verified: response.user.is_verified };
          localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));

          if (wasUnverified && response.user.is_verified) {
            localStorage.removeItem('verify-banner-dismissed');
            bannerDismissed = false;
            showToast('Â¡Tu email ha sido verificado exitosamente! âœ“', 'success', 5000);
          }

          updateBanner(response.user);
        }
      } catch (e) {

      }
    }, 10000);

  } catch (e) {
    console.error('Error manejando banner de verificaciÃ³n:', e);
  }
})();

  </script>

</body>

</html>

