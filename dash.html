<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hub - UltraFilm</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json">
    <meta name="description" content="Dashboard de UltraFilm - Gestiona tu colecciÃ³n personal de pelÃ­culas y series. Accede a favoritos, listas y recomendaciones.">
    <script>
        if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    </script>
</head>

<body>

    <header>
        <h1>ğŸ¬ UltraFilm</h1>
    </header>

    <main>
        <div class="welcome-section">
            <h2>Bienvenido, <span id="usuario-nombre"></span></h2>
            <p>Tu plataforma de entretenimiento favorita</p>
        </div>

        <div id="verify-banner">
            <strong>âš ï¸ Tu correo electrÃ³nico no estÃ¡ verificado</strong>
            <p>Revisa tu bandeja de entrada (o la carpeta de spam). Si no recibiste el email, puedes reenviarlo ahora.
            </p>
            <div class="banner-buttons">
                <button id="resend-verify-btn">ğŸ“§ Reenviar email de verificaciÃ³n</button>
                <button id="dismiss-verify-btn">â° Recordar despuÃ©s</button>
            </div>
        </div>

        <div class="dashboard-grid">
            <a href="peliculas.html" class="dashboard-card">
                <span class="card-icon">ğŸ¬</span>
                <div class="card-title">PelÃ­culas</div>
                <div class="card-description">Explora miles de pelÃ­culas de todos los gÃ©neros</div>
            </a>

            <a href="series.html" class="dashboard-card">
                <span class="card-icon">ğŸ“º</span>
                <div class="card-title">Series</div>
                <div class="card-description">Descubre las mejores series y temporadas</div>
            </a>

            <a href="favoritos.html" class="dashboard-card">
                <span class="card-icon">â¤ï¸</span>
                <div class="card-title">Favoritos</div>
                <div class="card-description">Accede rÃ¡pido a tu contenido favorito</div>
            </a>

            <a href="guardados.html" class="dashboard-card">
                <span class="card-icon">ğŸ“Œ</span>
                <div class="card-title">Guardados</div>
                <div class="card-description">Contenido que quieres ver mÃ¡s tarde</div>
            </a>

            <a href="manage.html" class="dashboard-card">
                <span class="card-icon">âš™ï¸</span>
                <div class="card-title">Gestionar cuenta</div>
                <div class="card-description">Configura tu perfil y preferencias</div>
            </a>
        </div>

        <div class="logout-section">
            <button id="logout-btn">ğŸšª Cerrar sesiÃ³n</button>
        </div>
    </main>

    <div id="logout-modal">
        <div class="modal-content">
            <h3>Â¿Cerrar sesiÃ³n?</h3>
            <p>Â¿EstÃ¡s seguro que quieres cerrar sesiÃ³n?</p>
            <div>
                <button id="cancel-logout-btn">Cancelar</button>
                <button id="confirm-logout-btn">Cerrar sesiÃ³n</button>
            </div>
        </div>
    </div>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <footer>
        Â© 2025 UltraFilm Cine & Series. Todos los derechos reservados.
    </footer>

    <script>

  function checkAuthentication() {
    const token = localStorage.getItem("jwt");
    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

    if (!token || !loggedInUser || !loggedInUser.id) {
      console.error('AutenticaciÃ³n fallida - Redirigiendo a login');
      localStorage.removeItem("jwt");
      localStorage.removeItem("loggedInUser");
      window.location.href = "login.html";
      return false;
    }
    return true;
  }

  if (!checkAuthentication()) {
    throw new Error('AutenticaciÃ³n fallida');
  }

  const token = localStorage.getItem("jwt");
  const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

  if (!loggedInUser || !loggedInUser.username) {
    window.location.href = "login.html";
  } else {
    document.getElementById('usuario-nombre').textContent = loggedInUser.username;
  }

  document.getElementById('logout-btn').addEventListener('click', () => {
    const modal = document.getElementById('logout-modal');
    modal.style.display = 'flex';
    setTimeout(() => document.getElementById('cancel-logout-btn').focus(), 50);
  });

  document.getElementById('cancel-logout-btn').addEventListener('click', () => {
    document.getElementById('logout-modal').style.display = 'none';
  });

  document.getElementById('confirm-logout-btn').addEventListener('click', () => {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("jwt");
    window.location.href = "index.html";
  });

  document.getElementById('logout-modal').addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.getElementById('logout-modal').style.display = 'none';
    }
  });

  function showToast(message, type = 'info', duration = 3500) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('hide');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  async function safeFetch(url, options = {}) {

    if (!checkAuthentication()) {
      throw new Error('SesiÃ³n expirada');
    }

    try {
      const res = await fetch(url, options);
      if (!res.ok) {
        let errMsg = `Error ${res.status}`;
        try {
          const data = await res.json();
          errMsg = data.error || errMsg;

          if (errMsg.toLowerCase().includes('usuario no encontrado') || 
              errMsg.toLowerCase().includes('user not found') ||
              res.status === 401 || res.status === 403) {
            console.error('Usuario no encontrado o no autorizado - Cerrando sesiÃ³n');
            localStorage.removeItem("jwt");
            localStorage.removeItem("loggedInUser");
            window.location.href = "login.html";
            return;
          }
        } catch {}
        throw new Error(errMsg);
      }
      return await res.json();
    } catch (err) {
      showToast(err.message || 'Error de conexiÃ³n con el servidor.', 'error');
      throw err;
    }
  }

  (function handleVerificationBanner() {
    try {
      const banner = document.getElementById('verify-banner');

      if (!banner) {
        return;
      }

      if (!checkAuthentication()) {
        return;
      }

      let bannerDismissed = localStorage.getItem('verify-banner-dismissed') === 'true';

      function updateBanner(userData) {
        const user = userData || loggedInUser;

        if (user && !user.is_verified && !bannerDismissed) {
          banner.style.display = 'block';
        } else {
          banner.style.display = 'none';
        }
      }

      (async function loadInitialState() {
        try {
          const response = await safeFetch('https://api.ultrafilm.online/user', {
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response && response.user) {
            const updatedUser = { ...loggedInUser, is_verified: response.user.is_verified };
            localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
            updateBanner(response.user);
          }
        } catch (e) {
          updateBanner(loggedInUser);
        }
      })();

      const resendBtn = document.getElementById('resend-verify-btn');
      if (resendBtn) {
        resendBtn.addEventListener('click', async () => {
          resendBtn.disabled = true;
          resendBtn.textContent = 'ğŸ“§ Enviando...';

          try {
            await safeFetch('https://api.ultrafilm.online/resend-verification', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: loggedInUser.email })
            });

            showToast('Email de verificaciÃ³n reenviado. Revisa tu bandeja (incluido spam).', 'success', 6000);
          } catch (e) {
            console.error('Error reenviando verificaciÃ³n:', e);
          } finally {
            resendBtn.disabled = false;
            resendBtn.textContent = 'ğŸ“§ Reenviar email de verificaciÃ³n';
          }
        });
      }

      const dismissBtn = document.getElementById('dismiss-verify-btn');
      if (dismissBtn) {
        dismissBtn.addEventListener('click', () => {
          banner.style.display = 'none';
          bannerDismissed = true;
          localStorage.setItem('verify-banner-dismissed', 'true');
        });
      }

      setInterval(async () => {

        if (!checkAuthentication()) {
          return;
        }

        try {
          const response = await safeFetch('https://api.ultrafilm.online/user', {
            method: 'GET',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response && response.user) {
            const storedUser = JSON.parse(localStorage.getItem('loggedInUser'));
            const wasUnverified = !storedUser.is_verified;

            const updatedUser = { ...storedUser, is_verified: response.user.is_verified };
            localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));

            if (wasUnverified && response.user.is_verified) {
              localStorage.removeItem('verify-banner-dismissed');
              bannerDismissed = false;
              showToast('Â¡Tu email ha sido verificado exitosamente! âœ“', 'success', 5000);
            }

            updateBanner(response.user);
          }
        } catch (e) {

        }
      }, 10000);

    } catch (e) {
      console.error('Error manejando banner de verificaciÃ³n:', e);
    }
  })();

  setInterval(() => {
    if (!checkAuthentication()) {
      showToast('SesiÃ³n expirada. Redirigiendo...', 'error', 2000);
    }
  }, 30000);

  window.addEventListener('focus', () => {
    if (!checkAuthentication()) {
      showToast('SesiÃ³n expirada. Redirigiendo...', 'error', 2000);
    }
  });

    </script>

</body>

</html>