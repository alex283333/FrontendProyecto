<!DOCTYPE html>

<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registro | Catálogo de Películas y Series</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#121212">
    <script>
        if ('serviceWorker' in navigator) {

      window.addEventListener('load', () => {

        navigator.serviceWorker.register('sw.js');

      });

    }

    </script>
</head>

<body>

    <div class="container">

        <h1>Crear Cuenta</h1>

        <input type="text" id="username" placeholder="Usuario" autocomplete="username" />

        <input type="email" id="email" placeholder="Email" autocomplete="email" />

        <input type="password" id="password" placeholder="Contraseña" autocomplete="new-password" />

        <input type="password" id="confirm-password" placeholder="Confirmar Contraseña" autocomplete="new-password" />

        <button class="btn" onclick="register()">Registrarse</button>

        <div id="message"></div>

        <p style="margin-top: 20px; color: #ccc;">

            ¿Ya tienes cuenta? <a href="login.html" style="color:#e50914; text-decoration:none;">Iniciar sesión</a>

        </p>

    </div>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>

    function showToast(message, type = 'info', duration = 3500) {

      const container = document.getElementById('toast-container');

      const toast = document.createElement('div');

      toast.className = `toast toast-${type}`;

      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => {

        toast.classList.add('hide');

        toast.addEventListener('transitionend', () => toast.remove());

      }, duration);

    }

    async function safeFetch(url, options = {}) {

      try {

        const res = await fetch(url, options);

        if (!res.ok) {

          let errMsg = `Error ${res.status}`;

          try {

            const data = await res.json();

            errMsg = data.error || errMsg;

          } catch {}

          throw new Error(errMsg);

        }

        return await res.json();

      } catch (err) {

        showToast(err.message || 'Error de conexión con el servidor.', 'error');

        throw err;

      }

    }

    function register() {

      const username = document.getElementById("username").value.trim();

      const email = document.getElementById("email").value.trim();

      const password = document.getElementById("password").value;

      const confirmPassword = document.getElementById("confirm-password").value;

      const message = document.getElementById("message");

      message.style.color = "#ff4444";

      if (!username && !email && !password && !confirmPassword) {

        message.textContent = "Por favor, completa todos los campos.";

        return;

      }

      if (!username) {

        message.textContent = "El campo de usuario está vacío.";

        return;

      }

      if (!email) {

        message.textContent = "El campo de email está vacío.";

        return;

      }

      if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/i)) {

        message.textContent = "El email debe ser una dirección válida.";

        return;

      }

      if (!password) {

        message.textContent = "El campo de contraseña está vacío.";

        return;

      }

      if (!confirmPassword) {

        message.textContent = "Debes confirmar la contraseña.";

        return;

      }

      if (password.length < 8) {

        message.textContent = "La contraseña debe tener al menos 8 caracteres.";

        return;

      }

      if (!/[A-Z]/.test(password)) {

        message.textContent = "La contraseña debe incluir al menos una letra mayúscula.";

        return;

      }

      if (!/[a-z]/.test(password)) {

        message.textContent = "La contraseña debe incluir al menos una letra minúscula.";

        return;

      }

      if (!/\d/.test(password)) {

        message.textContent = "La contraseña debe incluir al menos un número.";

        return;

      }

      if (password !== confirmPassword) {

        message.textContent = "Las contraseñas no coinciden.";

        return;

      }

  safeFetch('https://api.ultrafilm.online/register_public', {

        method: 'POST',

        headers: { 'Content-Type': 'application/json' },

        body: JSON.stringify({ username, email, password })

      })

      .then(data => {

        if (data.ok) {

          message.style.color = "#4CAF50";

          message.textContent = "¡Registro exitoso! Revisa tu email (incluido spam). Te enviamos un enlace para verificar tu cuenta. Serás redirigido al inicio de sesión...";

          setTimeout(() => {

            window.location.href = "login.html";

          }, 3500);

        } else if (data && data.error) {

          if (data.error.toLowerCase().includes('usuario') && data.error.toLowerCase().includes('email')) {

            message.textContent = "El usuario o el email ya están registrados.";

          } else if (data.error.toLowerCase().includes('usuario')) {

            message.textContent = "El nombre de usuario ya está en uso.";

          } else if (data.error.toLowerCase().includes('email')) {

            message.textContent = "El email ya está registrado.";

          } else {

            message.textContent = data.error;

          }

        } else {

          message.textContent = "Error en el registro.";

        }

      })

      .catch((err) => {

        if (err && err.message && err.message.toLowerCase().includes('usuario o email ya existe')) {

          message.textContent = "El usuario o el email ya están registrados.";

        } else {

          message.textContent = "Error de conexión con el servidor.";

        }

      });

    }

    </script>

</body>

</html>