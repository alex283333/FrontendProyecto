<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Ver más tarde - UltraFilm</title>

    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#121212">

    <link rel="preconnect" href="https://api.ultrafilm.online">
    <link rel="preconnect" href="https://image.tmdb.org">
    <link rel="preconnect" href="https://www.themoviedb.org">
    <link rel="dns-prefetch" href="https://api.ultrafilm.online">
    <link rel="dns-prefetch" href="https://image.tmdb.org"> 

    <script>

        (function() {
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            const url = args[0];
            let urlString = typeof url === 'string' ? url : (url && url.url ? url.url : (url && url.toString ? url.toString() : ''));
            if (urlString.includes('api.themoviedb.org') || urlString.includes('api_key=')) {
              console.error('❌ BLOQUEADO (HEAD): api.themoviedb.org');
              throw new Error('Llamadas directas a api.themoviedb.org bloqueadas');
            }
            if (urlString.includes('ultrafilm.online/tmdb') && !urlString.includes('api.ultrafilm.online')) {
              console.error('❌ BLOQUEADO (HEAD): ultrafilm.online/tmdb');
              throw new Error('URL incorrecta. Usa api.ultrafilm.online/tmdb');
            }
            return originalFetch.apply(this, args);
          };
        })();

        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js');
          });
        }
    </script>
</head>

<body>

    <header>⏰ Ver más tarde</header>

    <nav>

        <a href="dash.html">Inicio</a>

        <a href="peliculas.html">Películas</a>

        <a href="series.html">Series</a>

        <a href="favoritos.html" id="nav-favoritos-btn"
            style="background:#333;color:#eee;font-weight:bold;">Favoritos</a>

        <a href="guardados.html" aria-current="page" style="background:#333;color:#eee;font-weight:bold;">Ver más

            tarde</a>

        <button id="logout-btn" class="btn-logout">Cerrar sesión</button>

    </nav>

    <main>

        <div id="guardados-container" aria-live="polite" aria-relevant="additions"></div>

    </main>

    <footer>© 2025 UltraFilm Cine & Series. Todos los derechos reservados.</footer>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div id="movie-modal" class="modal" style="display:none;">

        <div class="modal-content" tabindex="0">

            <button class="modal-close" id="modal-close-btn" aria-label="Cerrar modal">&times;</button>

            <div id="modal-body"></div>

        </div>

    </div>

    <script data-cfasync="false" src="/js/tmdb.js?v=4-interceptor-agresivo"></script>
    <script>
        const token = localStorage.getItem('jwt');

    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

    if (!token) {

      alert('No hay JWT en localStorage');

      localStorage.removeItem('jwt');

      localStorage.removeItem('loggedInUser');

      window.location.href = 'login.html';

    }

    if (!loggedInUser || !loggedInUser.id) {

      alert('No hay usuario en localStorage');

      localStorage.removeItem('jwt');

      localStorage.removeItem('loggedInUser');

      window.location.href = 'login.html';

    }

    document.getElementById('logout-btn').addEventListener('click', () => {

      localStorage.removeItem('loggedInUser');

      window.location.href = 'index.html';

    });

    const guardadosContainer = document.getElementById('guardados-container');

    function showToast(message, type = 'info', duration = 3500) {

      const container = document.getElementById('toast-container');

      const toast = document.createElement('div');

      toast.className = `toast toast-${type}`;

      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => {

        toast.classList.add('hide');

        toast.addEventListener('transitionend', () => toast.remove());

      }, duration);

    }

    async function safeFetch(url, options = {}) {

      try {

        const res = await fetch(url, options);

        if (!res.ok) {

          let errMsg = `Error ${res.status}`;

          try {

            const data = await res.json();

            errMsg = data.error || errMsg;

          } catch {}

          throw new Error(errMsg);

        }

        return await res.json();

      } catch (err) {

        showToast(err.message || 'Error de conexión con el servidor.', 'error');

        throw err;

      }

    }

async function loadGuardados() {
    let guardadosSeries = [];
    let guardadosPeliculas = [];

    try {
        const resSeries = await fetch(`https://api.ultrafilm.online/guardados?user_id=${loggedInUser.id}`, {
            headers: { 'Authorization': 'Bearer ' + token },
            cache: 'no-store' 
        });
        guardadosSeries = await resSeries.json();
    } catch (e) {
        guardadosSeries = [];
    }

    try {
        const resPeliculas = await fetch(`https://api.ultrafilm.online/guardados_peliculas?user_id=${loggedInUser.id}`, {
            headers: { 'Authorization': 'Bearer ' + token },
            cache: 'no-store' 
        });
        guardadosPeliculas = await resPeliculas.json();
    } catch (e) {
        guardadosPeliculas = [];
    }

    const guardados = [...guardadosSeries, ...guardadosPeliculas];

    if (!guardados.length) {
        guardadosContainer.innerHTML = '<p style="color:#ccc; text-align:center;">No tienes títulos guardados para ver más tarde.</p>';
        return;
    }

    guardadosContainer.innerHTML = guardados.map(p => {
        const titulo = p.title || p.name || 'Título no disponible';
        const tipo = p.name ? 'serie' : 'pelicula';
        const poster = p.poster_path ? 'https://image.tmdb.org/t/p/w500' + p.poster_path : 'https://via.placeholder.com/500x750?text=Sin+Imagen';
        return `
            <article class="card" tabindex="0" aria-label="Guardado: ${titulo}" data-movie-id="${p.id}" data-type="${tipo}">
                <div class="card-media">
                    <img src="${poster}" alt="Poster de ${titulo}" />
                </div>
                <div class="card-body">
                    <h3 class="card-title">${titulo}</h3>
                    <p class="card-description">${p.overview || 'Sin descripción disponible.'}</p>
                </div>
                <div class="card-footer">
                    <button class="remove-guardar-btn" data-id="${p.id}" data-tipo="${tipo}" aria-label="Quitar ${titulo} de guardados" onclick="handleRemoveGuardado(event, this)">
                        ❌ Quitar de guardados
                    </button>
                </div>
            </article>
        `;
    }).join('');

    setupCardHandlers();
}

async function handleRemoveGuardado(event, btn) {
    event.stopImmediatePropagation();
    event.preventDefault();

    const itemId = btn.getAttribute('data-id');
    const tipo = btn.getAttribute('data-tipo');
    const card = btn.closest('.card');
    const titulo = card.querySelector('.card-title').textContent;
    btn.disabled = true;

    try {
        await quitarGuardado(itemId, tipo);
        showToast(`Eliminaste "${titulo}" de guardados.`, 'success');
        card.classList.add('removing');
        setTimeout(() => card.remove(), 250);
        if (!document.querySelector('#guardados-container .card')) {
            document.querySelector('#guardados-container').innerHTML = '<p style="color:#ccc; text-align:center;">No tienes títulos guardados para ver más tarde.</p>';
        }
    } catch {
        btn.disabled = false;
    }
}

function setupCardHandlers() {
    document.querySelectorAll('#guardados-container .card').forEach(card => {

        const newCard = card.cloneNode(true);
        card.parentNode.replaceChild(newCard, card);

        newCard.addEventListener('click', (e) => {

            if (e.target.closest('.remove-guardar-btn') || e.target.closest('.card-footer')) {
                return;
            }

            const movieId = newCard.getAttribute('data-movie-id');
            const type = newCard.getAttribute('data-type');
            if (typeof openMovieModal === 'function') {
                openMovieModal(movieId, type);
            }
        });

        newCard.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const movieId = newCard.getAttribute('data-movie-id');
                const type = newCard.getAttribute('data-type');
                if (typeof openMovieModal === 'function') {
                    openMovieModal(movieId, type);
                }
            }
        });
    });
}

async function quitarGuardado(itemId, tipo) {
    if (tipo === 'serie') {
        await safeFetch('https://api.ultrafilm.online/guardados', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ user_id: loggedInUser.id, serie_id: Number(itemId) }),
            cache: 'no-store'
        });
    } else {
        await safeFetch('https://api.ultrafilm.online/guardados_peliculas', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ user_id: loggedInUser.id, pelicula_id: Number(itemId) }),
            cache: 'no-store' 
        });
    }
}

loadGuardados();

    const IMG_URL = 'https://image.tmdb.org/t/p/w500';

    const modal = document.getElementById('movie-modal');

    const modalBody = document.getElementById('modal-body');

    const modalCloseBtn = document.getElementById('modal-close-btn');

    let lastFocusedElement = null;

    function attachCardHandlers() {

      document.querySelectorAll('#guardados-container .card').forEach(card => {

        card.addEventListener('click', function(e) {

          if (e.target.closest('.remove-guardar-btn')) return;

          const movieId = this.getAttribute('data-movie-id');

          const tipo = this.getAttribute('data-type');

          if (movieId) openMovieModal(movieId, tipo);

        });

        card.addEventListener('keydown', function(e) {

          if ((e.key === 'Enter' || e.key === ' ') && !e.target.closest('.remove-guardar-btn')) {

            e.preventDefault();

            const movieId = this.getAttribute('data-movie-id');

            const tipo = this.getAttribute('data-type');

            if (movieId) openMovieModal(movieId, tipo);

          }

        });

      });

    }

    function openMovieModal(movieId, tipo) {

      lastFocusedElement = document.activeElement;

      showMovieDetails(movieId, tipo);

      modal.style.display = 'flex';

      document.body.style.overflow = 'hidden';

      setTimeout(() => {

        modal.querySelector('.modal-content').focus();

      }, 100);

    }

    function closeMovieModal() {

      modal.style.display = 'none';

      document.body.style.overflow = '';

      modalBody.innerHTML = '';

      if (lastFocusedElement) lastFocusedElement.focus();

    }

    modalCloseBtn.addEventListener('click', closeMovieModal);

    modal.addEventListener('click', (e) => {

      if (e.target === modal) closeMovieModal();

    });

    document.addEventListener('keydown', (e) => {

      if (modal.style.display === 'flex' && e.key === 'Escape') closeMovieModal();

    });

    async function showMovieDetails(id, tipo) {

      modalBody.innerHTML = '<div style="text-align:center;padding:40px 0;">Cargando...</div>';

      try {

        const media = tipo === 'serie' ? 'tv' : 'movie';

        const [details, reviewsData, videosData] = await Promise.all([

          window.tmdbFetch(`/${media}/${id}`, { language: 'es-ES' }),

          window.tmdbFetch(`/${media}/${id}/reviews`, { language: 'es-ES', page: 1 }),

          window.tmdbFetch(`/${media}/${id}/videos`, { language: 'es-ES' })

        ]);

        let trailer = null;

        if (videosData.results && videosData.results.length) {

          trailer = videosData.results.find(v => v.type === 'Trailer' && v.site === 'YouTube') || videosData.results.find(v => v.site === 'YouTube');

        }

        const reviews = (reviewsData.results || []).slice(0, 4);

        const title = details.title || details.name || 'Título';

        const release = details.release_date || details.first_air_date || 'N/A';

        const runtime = details.runtime || (details.episode_run_time && details.episode_run_time[0]) || null;

        modalBody.innerHTML = `

          <div class="modal-movie-header">

            <img class="modal-movie-poster" src="${details.poster_path ? IMG_URL + details.poster_path : 'https://via.placeholder.com/500x750?text=No+Image'}" alt="Poster de ${title}" />

            <div class="modal-movie-info">

              <h2 class="modal-movie-title">${title}</h2>

              <div class="modal-movie-rating">⭐ ${details.vote_average ? details.vote_average.toFixed(1) : 'N/A'} / 10 (${details.vote_count || 0} votos)</div>

              <div class="modal-movie-overview">${details.overview || 'Sin descripción.'}</div>

              <div><b>Géneros:</b> ${details.genres && details.genres.length ? details.genres.map(g => g.name).join(', ') : 'N/A'}</div>

              <div><b>Fecha de estreno:</b> ${release}</div>

              <div><b>Duración:</b> ${runtime ? runtime + ' min' : 'N/A'}</div>

              <div style="margin-top:10px;">

                <b>Ver más:</b>

                <a href="https://www.themoviedb.org/${media}/${details.id}" target="_blank" rel="noopener" style="color:#00b3ff;">TMDB</a>

                ${details.homepage ? `| <a href="${details.homepage}" target="_blank" rel="noopener" style="color:#00ff99;">Sitio Oficial</a>` : ''}

              </div>

            </div>

          </div>

          <div>

            <div class="modal-section-title">Reseñas</div>

            <div class="modal-reviews">

              ${reviews.length ? reviews.map(r => `

                <div class="modal-review">

                  <div class="modal-review-author">${r.author}</div>

                  <div>${r.content.length > 300 ? r.content.slice(0,300) + '...' : r.content}</div>

                </div>

              `).join('') : '<div style="color:#aaa;">No hay reseñas disponibles.</div>'}

            </div>

          </div>

          <div>

            <div class="modal-section-title">Trailer</div>

            <div class="modal-trailer">

              ${trailer ? `<iframe src="https://www.youtube.com/embed/${trailer.key}" allowfullscreen title="Trailer" loading="lazy"></iframe>` : '<div style="color:#aaa;">No hay trailer disponible.</div>'}

            </div>

          </div>

        `;

      } catch (e) {

        modalBody.innerHTML = '<div style="color:#e50914;text-align:center;padding:40px 0;">Error al cargar detalles.</div>';

      }

    }

    </script>

    <script src="/js/maintenance.js" defer></script>

</body>

</html>