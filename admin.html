<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Panel Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0f;
            --card: rgba(15, 20, 35, 0.8);
            --accent: #e50914;
            --accent-glow: rgba(229, 9, 20, 0.4);
            --muted: #8b9cb5;
            --glass: rgba(255, 255, 255, 0.05);
            --neon-glow: 0 0 20px var(--accent-glow);
            --text-primary: #e6f1ff;
            --text-secondary: #a8b2d1;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #0f172a 50%, #1a0a0f 100%);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(229, 9, 20, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(101, 78, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 255, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: pulse 8s ease-in-out infinite;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(229, 9, 20, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(229, 9, 20, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.3;
        }

        .app {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .sidebar {
            width: 280px;
            background: rgba(10, 15, 30, 0.7);
            backdrop-filter: blur(20px);
            padding: 30px 20px;
            border-right: 1px solid rgba(229, 9, 20, 0.2);
            box-shadow: var(--neon-glow);
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent), transparent);
        }

        .brand {
            font-weight: 800;
            font-size: 1.5rem;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #e50914 0%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: relative;
        }

        .brand::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 2px;
            background: var(--accent);
            box-shadow: var(--neon-glow);
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav button {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            text-align: left;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .nav button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(229, 9, 20, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav button:hover {
            color: var(--text-primary);
            background: rgba(229, 9, 20, 0.1);
            border-color: rgba(229, 9, 20, 0.3);
            transform: translateX(5px);
        }

        .nav button:hover::before {
            left: 100%;
        }

        .nav button.active {
            color: #fff;
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.2), rgba(229, 9, 20, 0.1));
            border-color: rgba(229, 9, 20, 0.5);
            box-shadow: 0 0 15px rgba(229, 9, 20, 0.3);
        }

        .main {
            flex: 1;
            padding: 30px;
            background: transparent;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .hdr-left {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #e50914 0%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hdr-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent) 0%, #b20710 100%);
            border: none;
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px var(--accent-glow);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px var(--accent-glow);
            background: linear-gradient(135deg, #ff1a1a 0%, #d40000 100%);
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            box-shadow: none;
        }

        .btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(229, 9, 20, 0.3);
            color: var(--text-primary);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid rgba(229, 9, 20, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.05) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: rgba(229, 9, 20, 0.3);
            box-shadow: 0 12px 40px rgba(229, 9, 20, 0.2);
        }

        .card:hover::before {
            opacity: 1;
        }

        .table-container {
            background: var(--card);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(229, 9, 20, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            margin-top: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.1), transparent);
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(229, 9, 20, 0.2);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        tr:hover td {
            background: rgba(229, 9, 20, 0.05);
            color: var(--text-primary);
        }

        .search {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }

        input[type="search"] {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        input[type="search"]:focus {
            outline: none;
            border-color: rgba(229, 9, 20, 0.5);
            box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        input[type="search"]::placeholder {
            color: var(--muted);
        }

        .skeleton {
            height: 12px;
            background: linear-gradient(90deg, #101827, rgba(229, 9, 20, 0.3), #101827);
            border-radius: 6px;
            animation: shimmer 2s infinite;
            position: relative;
            overflow: hidden;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 0.8;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }

            100% {
                background-position: 200px 0;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .hdr-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 600px) {
            .main {
                padding: 20px 15px;
            }

            .card {
                padding: 20px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            th,
            td {
                padding: 12px 15px;
            }
        }

        .card::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #e50914, #ff6b6b, #e50914);
            border-radius: 18px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::after {
            opacity: 0.3;
        }
    </style>

    <script>
        (function(){
            try{

                var _adminToken = localStorage.getItem('adminToken') || localStorage.getItem('jwt');
                if(!_adminToken){

                    location.replace('403.shtml');
                    return;
                }

                document.documentElement.classList.add('js');
                document.addEventListener('DOMContentLoaded', function(){

                    document.body.classList.add('not-verified');
                });
            }catch(e){

                try{ location.replace('403.shtml'); }catch(_){ location.href='403.shtml'; }
            }
        })();
    </script>
</head>

<body class="pre-verify">

    <div id="pre-verify-screen"
        style="display:flex;align-items:center;justify-content:center;height:100vh;color:var(--muted)">
        <div style="text-align:center">
            <div style="font-size:28px;font-weight:700;margin-bottom:6px">Verificando sesi√≥n de administrador...</div>
            <div style="max-width:420px;margin:0 auto">Si tienes problemas, aseg√∫rate de cerrar sesi√≥n y entrar
                nuevamente.</div>
        </div>
    </div>

    <div id="app" class="app" aria-hidden="true">
        <aside class="sidebar">
            <div class="brand">UltraFilm ‚Äî Admin</div>
            <nav class="nav">
                <button id="nav-dashboard" class="active">Dashboard</button>
                <button id="nav-users">Usuarios</button>
                <button id="nav-logs">Logs</button>
            </nav>
            <div style="margin-top:20px;font-size:13px;color:var(--muted)">Token: <span id="token-state">‚Äî</span></div>
        </aside>

        <main class="main">
            <div class="header">
                <div class="hdr-left">
                    <h2 style="margin:0">Panel de administraci√≥n</h2>
                    <div style="color:var(--muted);font-size:14px">√Årea segura</div>
                </div>
                <div class="hdr-actions">
                    <button id="refresh-btn" class="btn secondary">Refrescar</button>
                    <button id="maintenance-btn" class="btn secondary" title="Activar / desactivar modo mantenimiento">Modo mantenimiento: <span id="maintenance-state">OFF</span></button>
                    <button id="logout-btn" class="btn">Cerrar sesi√≥n</button>
                </div>
            </div>

            <section id="dashboard" class="view">
                <div class="grid">
                    <div class="card">
                        <div style="color:var(--muted);font-size:13px">Usuarios registrados</div>
                        <div id="stat-users" style="font-size:22px;font-weight:700;padding-top:8px">‚Äî</div>
                    </div>
                    <div class="card">
                        <div style="color:var(--muted);font-size:13px">Sesiones activas</div>
                        <div id="stat-sessions" style="font-size:22px;font-weight:700;padding-top:8px">‚Äî</div>
                    </div>
                    <div class="card">
                        <div style="color:var(--muted);font-size:13px">Nuevos hoy</div>
                        <div id="stat-new" style="font-size:22px;font-weight:700;padding-top:8px">‚Äî</div>
                    </div>
                </div>

                <div class="card" style="margin-top:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="font-weight:700">Actividad reciente</div>
                        <div style="color:var(--muted);font-size:13px">√öltimas 24 horas</div>
                    </div>
                    <div id="recent-activity" style="margin-top:12px">
                        <table id="activity-table" style="width:100%;border-collapse:collapse">
                            <thead>
                                <tr>
                                    <th style="text-align:left;padding:8px;color:var(--muted);font-size:13px">Admin</th>
                                    <th style="text-align:left;padding:8px;color:var(--muted);font-size:13px">Acci√≥n
                                    </th>
                                    <th style="text-align:left;padding:8px;color:var(--muted);font-size:13px">Objetivo
                                    </th>
                                    <th style="text-align:left;padding:8px;color:var(--muted);font-size:13px">Hora</th>
                                </tr>
                            </thead>
                            <tbody id="activity-tbody">
                                <tr>
                                    <td colspan="4" style="padding:12px;color:var(--muted)">Cargando actividad...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="users" class="view" hidden>
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div style="font-weight:700">Usuarios</div>
                    <div class="search">
                        <input id="user-search" type="search" placeholder="Buscar por nombre o email" aria-label="Buscar usuarios">
                        <button id="user-refresh" class="btn secondary">Buscar</button>
                    </div>
                </div>

                <div class="table">
                    <table aria-live="polite">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr>
                                <td colspan="5" style="padding:16px;color:var(--muted)">Cargando usuarios...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="logs" class="view" hidden>
                <div style="font-weight:700">Logs del sistema</div>
                <div class="card" style="margin-top:12px">
                    <div id="logs-list">Cargando logs...</div>
                </div>
            </section>

        </main>
    </div>

    <div id="toast" aria-live="polite" style="position:fixed;right:18px;bottom:18px"></div>

    <script>
        (function(){
            const API_BASE = 'https://api.ultrafilm.online';
            let adminToken = localStorage.getItem('adminToken');
            const elApp = document.getElementById('app');
            const tokenState = document.getElementById('token-state');

            function toast(msg, type='info'){
                const t = document.createElement('div');
                t.textContent = msg; t.style.background = type==='error'? '#7b1111':'#1b2638';
                t.style.color = '#fff'; t.style.padding='10px 14px'; t.style.borderRadius='8px'; t.style.marginTop='8px';
                document.getElementById('toast').appendChild(t);
                setTimeout(()=>t.remove(),4500);
            }

            function fetchWithTimeout(resource, options = {}, timeout = 5000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                const opts = Object.assign({}, options, { signal: controller.signal });
                return fetch(resource, opts).finally(() => clearTimeout(id));
            }

            async function verifyToken(){
                try{

                    adminToken = localStorage.getItem('adminToken') || localStorage.getItem('jwt');
                    if(!adminToken) return null;

                    const res = await fetchWithTimeout(API_BASE + '/verify-admin', { headers: { 'Authorization': 'Bearer ' + adminToken } }, 5000);
                    if(!res || !res.ok) return null;
                    const js = await res.json();
                    return js;
                }catch(e){

                    return null;
                }
            }

            async function loadInitial(){
                const ok = await verifyToken();
                if(!ok || !ok.isAdmin){
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('jwt');
                    localStorage.removeItem('loggedInUser');
                    location.href='403.shtml';
                    return;
                }

                document.body.classList.remove('not-verified');

                document.body.classList.remove('pre-verify');

                try{ const pv = document.getElementById('pre-verify-screen'); if(pv) pv.remove(); }catch(e){}
                elApp.setAttribute('aria-hidden','false');
                adminToken = localStorage.getItem('adminToken');
                tokenState.textContent = adminToken ? 'OK' : '‚Äî';

                fetchStats();
                fetchUsers();
                fetchLogs();
                fetchActivity();
                debugStats();
            }

async function debugStats() {
    console.log('=== DEBUG STATS ===');

    try {

        const statsRes = await fetch(API_BASE+'/admin/stats',{headers:{'Authorization':'Bearer '+adminToken}});
        const statsData = await statsRes.json();
        console.log('üìä Stats endpoint:', statsData);

        const usersRes = await fetch(API_BASE+'/admin/users',{headers:{'Authorization':'Bearer '+adminToken}});
        const usersData = await usersRes.json();
        console.log('üë• Users endpoint (primeros 3):', usersData.slice(0, 3));

        if (Array.isArray(usersData)) {
            const activeSessions = calculateActiveSessions(usersData);
            const newToday = calculateNewToday(usersData);
            console.log('üßÆ C√°lculos manuales:', { activeSessions, newToday });

            console.log('‚è∞ Ejemplo de timestamps de usuarios:');
            usersData.slice(0, 3).forEach((user, i) => {
                console.log(`Usuario ${i+1}:`, {
                    id: user.id,
                    name: user.name,
                    last_activity: user.last_activity,
                    last_login: user.last_login,
                    created_at: user.created_at,
                    updated_at: user.updated_at
                });
            });
        }

    } catch (e) {
        console.error('‚ùå Debug stats failed:', e);
    }
}

window.debugStats = debugStats;

async function fetchStats(){
    const statUsers = document.getElementById('stat-users');
    const statSessions = document.getElementById('stat-sessions');
    const statNew = document.getElementById('stat-new');

    try{

        const statsRes = await fetch(API_BASE+'/admin/stats',{headers:{'Authorization':'Bearer '+adminToken}});
        if(!statsRes.ok) throw new Error('no-stats');
        const statsData = await statsRes.json();

        const usersRes = await fetch(API_BASE+'/admin/users',{headers:{'Authorization':'Bearer '+adminToken}});
        if(!usersRes.ok) throw new Error('no-users');
        const usersData = await usersRes.json();

        console.log('Stats data:', statsData);
        console.log('Users data:', usersData);

        statUsers.textContent = statsData.totalUsers ?? '‚Äî';

        const activeSessions = calculateActiveSessions(usersData);
        statSessions.textContent = activeSessions;

        const newToday = calculateNewToday(usersData);
        statNew.textContent = newToday;

    }catch(e){
        console.error('Error fetching stats:', e);

        statUsers.textContent = '‚Äî'; 
        statSessions.textContent = '‚Äî'; 
        statNew.textContent = '‚Äî';
    }
}

function calculateActiveSessions(users) {
    if (!Array.isArray(users)) return 0;

    const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);

    return users.filter(user => {

        const lastActivity = user.last_activity || user.last_login || user.updated_at || user.created_at;
        if (!lastActivity) return false;

        try {
            const activityDate = new Date(lastActivity);
            return !isNaN(activityDate) && activityDate > twoHoursAgo;
        } catch {
            return false;
        }
    }).length;
}

function calculateNewToday(users) {
    if (!Array.isArray(users)) return 0;

    const today = new Date();
    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    return users.filter(user => {

        const createdAt = user.created_at || user.registration_date || user.date_joined;
        if (!createdAt) return false;

        try {
            const createDate = new Date(createdAt);
            return !isNaN(createDate) && createDate >= todayStart;
        } catch {
            return false;
        }
    }).length;
}

async function calculateManualStats() {
    const statUsers = document.getElementById('stat-users');
    const statSessions = document.getElementById('stat-sessions');
    const statNew = document.getElementById('stat-new');

    try {

        const res = await fetch(API_BASE+'/admin/users',{headers:{'Authorization':'Bearer '+adminToken}});
        if(!res.ok) throw new Error('no-users');
        const users = await res.json();

        if(!Array.isArray(users)) throw new Error('invalid-users-data');

        const totalUsers = users.length;
        statUsers.textContent = totalUsers;

        const today = new Date().toISOString().split('T')[0];
        const newToday = users.filter(user => {
            if (!user.created_at) return false;
            const userDate = new Date(user.created_at).toISOString().split('T')[0];
            return userDate === today;
        }).length;
        statNew.textContent = newToday;

        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        const activeSessions = users.filter(user => {
            if (!user.last_activity) return false;
            const lastActivity = new Date(user.last_activity);
            return lastActivity > oneHourAgo;
        }).length;

        statSessions.textContent = activeSessions;

        console.log('Manual stats calculated:', { totalUsers, newToday, activeSessions });

    } catch (error) {
        console.error('Error in manual stats calculation:', error);
        throw error;
    }
}

            async function fetchUsers(q=''){ 
                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;color:var(--muted)">Cargando usuarios...</td></tr>';
                try{
                    const res = await fetch(API_BASE+'/admin/users?search='+encodeURIComponent(q),{headers:{'Authorization':'Bearer '+adminToken}});
                    if(!res.ok) throw new Error('no-users');
                    const data = await res.json();
                    if(!Array.isArray(data)) data=[];
                    if(data.length===0){ tbody.innerHTML='<tr><td colspan="5" style="padding:16px;color:var(--muted)">No se encontraron usuarios.</td></tr>'; return; }
                    tbody.innerHTML = data.map(u=>`<tr><td>${u.id}</td><td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td><td>${u.role||'user'}</td><td><button class="btn small" data-id="${u.id}" data-action="toggle-role">Toggle role</button> <button class="btn secondary small" data-id="${u.id}" data-action="reset-password">Reset password</button> <button class="btn secondary small" data-id="${u.id}" data-action="ban">Ban</button></td></tr>`).join('');

                    tbody.querySelectorAll('button').forEach(b=>b.addEventListener('click', onUserAction));
                }catch(e){
                    tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;color:var(--muted)">Error cargando usuarios.</td></tr>';
                }
            }

            async function onUserAction(ev){
                const id = ev.currentTarget.dataset.id;
                const action = ev.currentTarget.dataset.action;
                if(action==='toggle-role'){
                    try{
                        const res = await fetch(API_BASE+`/admin/users/${id}/toggle-role`,{method:'POST',headers:{'Authorization':'Bearer '+adminToken}});
                        if(!res.ok) throw new Error('error');
                        toast('Rol actualizado'); fetchUsers(document.getElementById('user-search').value);
                    }catch(e){toast('No se pudo cambiar rol','error')}
                } else if(action==='reset-password'){
                    if(!confirm('¬øConfirmar reset de contrase√±a para este usuario? Se le enviar√° un email con la nueva contrase√±a.')) return;
                    try{
                        const res = await fetch(API_BASE+`/admin/users/${id}/reset-password`,{method:'POST',headers:{'Authorization':'Bearer '+adminToken}});
                        if(!res.ok) throw new Error('error');
                        toast('Contrase√±a restablecida y email enviado');
                        fetchUsers(document.getElementById('user-search').value);
                    }catch(e){toast('No se pudo restablecer la contrase√±a','error')}
                } else if(action==='ban'){
                    if(!confirm('¬øConfirmar ban a este usuario?')) return;
                    try{const res=await fetch(API_BASE+`/admin/users/${id}/ban`,{method:'POST',headers:{'Authorization':'Bearer '+adminToken}}); if(!res.ok) throw new Error(); toast('Usuario baneado'); fetchUsers(document.getElementById('user-search').value);}catch(e){toast('No se pudo banear','error')}
                }
            }

            async function fetchLogs(){
                const el = document.getElementById('logs-list');
                el.textContent='Cargando logs...';
                try{
                    const res = await fetch(API_BASE+'/admin/logs',{headers:{'Authorization':'Bearer '+adminToken}});
                    if(!res.ok) throw new Error('no-logs');
                    const d = await res.json();
                    el.innerHTML = '<ul style="list-style:none;padding-left:0;margin:0">'+(d.slice(0,20).map(l=>`<li style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${escapeHtml(l.level)}</strong> ${escapeHtml(l.msg)} <span style="color:var(--muted);font-size:12px">${escapeHtml(l.ts)}</span></li>`).join(''))+'</ul>';
                }catch(e){ el.textContent='No se pudieron cargar logs.' }
            }

            async function fetchActivity(){
                const tbody = document.getElementById('activity-tbody');
                if(!tbody) return;
                tbody.innerHTML = '<tr><td colspan="4" style="padding:12px;color:var(--muted)">Cargando actividad...</td></tr>';
                try{

                    const token = localStorage.getItem('adminToken') || localStorage.getItem('jwt');
                    if(!token){ tbody.innerHTML = '<tr><td colspan="4" style="padding:12px;color:var(--muted)">No hay token de administrador en localStorage.</td></tr>'; return; }

                    const res = await fetch(API_BASE + '/admin/activity', { headers: { 'Authorization': 'Bearer ' + token } });
                    if(!res.ok){
                        const text = await res.text().catch(()=>res.statusText||'');
                        tbody.innerHTML = `<tr><td colspan="4" style="padding:12px;color:#ffb0b0">Error cargando actividad: ${res.status} ${escapeHtml(text)}</td></tr>`;
                        console.error('fetchActivity failed', res.status, text);
                        return;
                    }

                    const data = await res.json();
                    if(!Array.isArray(data) || data.length===0){ tbody.innerHTML = '<tr><td colspan="4" style="padding:12px;color:var(--muted)">Actualmente est√° vac√≠o.</td></tr>'; return; }

                    const now = Date.now();
                    const dayAgo = now - 24*60*60*1000;
                    const recent = data.filter(it => {
                        if(!it.ts) return false;
                        const t = new Date(it.ts);
                        return !isNaN(t) && t.getTime() >= dayAgo;
                    }).slice(0,8);

                    const toShow = recent.length ? recent : data.slice(0,6);
                    tbody.innerHTML = toShow.map(it => {
                        const ts = it.ts ? escapeHtml(timeAgo(new Date(it.ts))) : '';
                        const adminLabel = it.admin && (it.admin.username || it.admin.email) ? escapeHtml(it.admin.username || it.admin.email) + (it.admin.role? ' ('+escapeHtml(it.admin.role)+')':'') : '';
                        const targetLabel = it.target && (it.target.username || it.target.email) ? escapeHtml(it.target.username || it.target.email) : '';

                        const actionLabel = escapeHtml(it.message || it.action || '');
                        return `<tr style="border-bottom:1px solid rgba(255,255,255,0.02)"><td style="padding:8px">${adminLabel}</td><td style="padding:8px">${actionLabel}</td><td style="padding:8px">${targetLabel}</td><td style="padding:8px;color:var(--muted);font-size:13px">${ts}</td></tr>`;
                    }).join('');

                }catch(e){
                    console.error('fetchActivity error', e);
                    tbody.innerHTML = `<tr><td colspan="4" style="padding:12px;color:#ffb0b0">Error cargando actividad: ${escapeHtml(String(e.message||e))}</td></tr>`;
                }
            }

            function parseLogTimestamp(raw){
                if(!raw) return null;

                const isoMatch = raw.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/);
                if(isoMatch){ const d = new Date(raw); if(!isNaN(d)) return d; }

                const apache = raw.match(/(\d{1,2})\/(\w{3})\/(\d{4}):(\d{2}:\d{2}:\d{2})/);
                if(apache){
                    const day = apache[1]; const mon = apache[2]; const yr = apache[3]; const time = apache[4];
                    const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
                    const mm = months[mon] ?? 0;
                    const parts = time.split(':');
                    const dt = new Date(Date.UTC(parseInt(yr), mm, parseInt(day), parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2])));
                    if(!isNaN(dt)) return dt;
                }

                const anyIso = raw.match(/\d{4}-\d{2}-\d{2} [\d:.]{8,}/);
                if(anyIso){ const d = new Date(anyIso[0].replace(' ','T')); if(!isNaN(d)) return d; }

                return null;
            }

            function timeAgo(input){
                if(!input) return '';
                const d = (input instanceof Date) ? input : new Date(input);
                if(isNaN(d)) return '';
                const now = Date.now();
                const diffSeconds = Math.round((d.getTime() - now) / 1000); 

                const abs = Math.abs(diffSeconds);

                const THIRTY_DAYS = 30 * 24 * 60 * 60;
                if(abs > THIRTY_DAYS){
                    try{
                        return d.toLocaleString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    }catch(e){
                        return d.toISOString().replace('T',' ').split('.')[0];
                    }
                }

                const rtf = new Intl.RelativeTimeFormat('es', { numeric: 'auto' });

                const sign = Math.sign(diffSeconds); 

                if(abs < 60) return rtf.format(sign * Math.round(abs), 'second');
                if(abs < 3600) return rtf.format(sign * Math.round(abs/60), 'minute');
                if(abs < 86400) return rtf.format(sign * Math.round(abs/3600), 'hour');
                if(abs < 604800) return rtf.format(sign * Math.round(abs/86400), 'day');
                if(abs < 2592000) return rtf.format(sign * Math.round(abs/604800), 'week');
                return rtf.format(sign * Math.round(abs/2592000), 'month');
            }

            function populateRecentActivity(logs){
                const el = document.getElementById('recent-activity');
                if(!Array.isArray(logs) || logs.length===0){ el.innerHTML = '<div style="color:var(--muted)">Actualmente est√° vac√≠o.</div>'; return; }
                const now = Date.now();
                const dayAgo = now - 24*60*60*1000;

                const mapped = logs.map(item=>{
                    const ts = item.ts || item.time || item.timestamp || '';
                    const parsed = parseLogTimestamp(ts) || parseLogTimestamp(item.msg) || null;
                    return { raw: item, parsedDate: parsed };
                });

                const recent = mapped.filter(m => m.parsedDate && m.parsedDate.getTime() >= dayAgo)
                                     .slice(0,8);

                if(recent.length>0){
                    el.innerHTML = recent.map(r=>{
                        const level = escapeHtml(r.raw.level||'info');
                        const msg = escapeHtml(r.raw.msg||r.raw.line||'');
                        const ts = escapeHtml(r.parsedDate.toISOString().replace('T',' ').split('.')[0]);
                        return `<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div style="font-size:13px;color:var(--muted)">${ts} ¬∑ ${level}</div><div style="margin-top:4px">${msg}</div></div>`;
                    }).join('');
                    return;
                }

                const fallback = logs.slice(0,6);
                if(fallback.length===0){ el.innerHTML = '<div style="color:var(--muted)">Actualmente est√° vac√≠o.</div>'; return; }
                el.innerHTML = fallback.map(l=>{
                    const level = escapeHtml(l.level||'info');
                    const msg = escapeHtml(l.msg||l.line||'');
                    const ts = escapeHtml(l.ts||'');
                    return `<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div style="font-size:13px;color:var(--muted)">${ts?ts+' ¬∑ '+level:level}</div><div style="margin-top:4px">${msg}</div></div>`;
                }).join('');
            }

            function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

            document.getElementById('nav-dashboard').addEventListener('click', ()=>switchView('dashboard'));
            document.getElementById('nav-users').addEventListener('click', ()=>switchView('users'));
            document.getElementById('nav-logs').addEventListener('click', ()=>switchView('logs'));
            document.getElementById('refresh-btn').addEventListener('click', ()=>{ fetchStats(); fetchUsers(document.getElementById('user-search').value); fetchLogs(); fetchActivity(); toast('Refrescado') });

            document.getElementById('user-refresh').addEventListener('click', ()=>fetchUsers(document.getElementById('user-search').value));

            document.getElementById('logout-btn').addEventListener('click', async ()=>{
                try{ await fetch(API_BASE+'/logout',{method:'POST',headers:{'Authorization':'Bearer '+adminToken}}); }catch(e){}
                localStorage.removeItem('adminToken'); localStorage.removeItem('jwt'); localStorage.removeItem('loggedInUser');
                location.href='index.html';
            });

            function switchView(id){ document.querySelectorAll('.view').forEach(v=>v.hidden=true); document.getElementById(id).hidden=false; document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active')); document.getElementById('nav-'+id).classList.add('active'); }

            setInterval(async ()=>{
                const ok = await verifyToken(); if(!ok || !ok.isAdmin){ localStorage.removeItem('adminToken'); localStorage.removeItem('jwt'); localStorage.removeItem('loggedInUser'); location.href='403.shtml'; }
            },30000);

            loadInitial();

            async function fetchMaintenanceStatus(){
                try{
                    const token = localStorage.getItem('adminToken') || localStorage.getItem('jwt');
                    if(!token) return;
                    const res = await fetch(API_BASE + '/maintenance', { headers: { 'Authorization': 'Bearer ' + token } });
                    if(!res.ok) return; const js = await res.json();
                    const el = document.getElementById('maintenance-state');
                    if(!el) return;
                    el.textContent = js && js.active ? 'ON' : 'OFF';
                    document.getElementById('maintenance-btn').style.background = js && js.active ? '#7b1111' : '';
                }catch(e){ console.warn('fetchMaintenanceStatus error', e); }
            }

            async function toggleMaintenance(){
                try{
                    const token = localStorage.getItem('adminToken') || localStorage.getItem('jwt');
                    if(!token) { toast('No hay token de administrador','error'); return; }
                    const el = document.getElementById('maintenance-state');
                    const currentlyOn = el && el.textContent === 'ON';
                    if(!confirm((currentlyOn? 'Desactivar' : 'Activar') + ' modo mantenimiento?')) return;
                    const res = await fetch(API_BASE + '/maintenance', { method: 'POST', headers: { 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ active: !currentlyOn, message: ( !currentlyOn ? 'Mantenimiento programado por administraci√≥n' : '' ) }) });
                    if(!res.ok){ const txt = await res.text().catch(()=>res.statusText||''); toast('Error al cambiar modo mantenimiento: '+txt,'error'); return; }
                    toast('Modo mantenimiento actualizado');
                    await fetchMaintenanceStatus();
                }catch(e){ console.error(e); toast('Error al cambiar modo mantenimiento','error'); }
            }

            document.getElementById('maintenance-btn').addEventListener('click', toggleMaintenance);

            fetchMaintenanceStatus();
            setInterval(fetchMaintenanceStatus, 30000);

            window._adminDebug = {fetchUsers,fetchStats,fetchLogs,fetchActivity};
        })();
    </script>
</body>

</html>