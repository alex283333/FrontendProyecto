<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Favoritos - UltraFilm</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#121212">

    <link rel="preconnect" href="https://api.ultrafilm.online">
    <link rel="preconnect" href="https://image.tmdb.org">
    <link rel="preconnect" href="https://www.themoviedb.org">
    <link rel="dns-prefetch" href="https://api.ultrafilm.online">
    <link rel="dns-prefetch" href="https://image.tmdb.org"> 

    <script>

        (function() {
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            const url = args[0];
            let urlString = typeof url === 'string' ? url : (url && url.url ? url.url : (url && url.toString ? url.toString() : ''));
            if (urlString.includes('api.themoviedb.org') || urlString.includes('api_key=')) {
              console.error('‚ùå BLOQUEADO (HEAD): api.themoviedb.org');
              throw new Error('Llamadas directas a api.themoviedb.org bloqueadas');
            }
            if (urlString.includes('ultrafilm.online/tmdb') && !urlString.includes('api.ultrafilm.online')) {
              console.error('‚ùå BLOQUEADO (HEAD): ultrafilm.online/tmdb');
              throw new Error('URL incorrecta. Usa api.ultrafilm.online/tmdb');
            }
            return originalFetch.apply(this, args);
          };
        })();

        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js');
          });
        }
    </script>
</head>

<body>
    <header>‚ù§Ô∏è Tus Favoritos</header>

    <nav>
        <a href="dash.html">Inicio</a>
        <a href="peliculas.html">Pel√≠culas</a>
        <a href="series.html">Series</a>
        <a href="favoritos.html" aria-current="page">Favoritos</a>
        <a href="guardados.html">Ver m√°s tarde</a>
        <button id="logout-btn" class="btn-logout">Cerrar sesi√≥n</button>
    </nav>

    <main>
        <div id="favoritos-container" aria-live="polite" aria-relevant="additions"></div>
    </main>

    <footer>¬© 2025 UltraFilm Cine & Series. Todos los derechos reservados.</footer>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div id="movie-modal" class="modal" style="display:none;">
        <div class="modal-content" tabindex="0">
            <button class="modal-close" id="modal-close-btn" aria-label="Cerrar modal">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <script data-cfasync="false" src="/js/tmdb.js?v=4-interceptor-agresivo"></script>
    <script>
        const token = localStorage.getItem('jwt');
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!token) {
      alert('No hay JWT en localStorage');
      localStorage.removeItem('jwt');
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    }
    if (!loggedInUser || !loggedInUser.id) {
      alert('No hay usuario en localStorage');
      localStorage.removeItem('jwt');
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    }

    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('loggedInUser');
      window.location.href = 'index.html';
    });

    const favoritosContainer = document.getElementById('favoritos-container');

    function showToast(message, type = 'info', duration = 3500) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('hide');
    toast.addEventListener('transitionend', () => toast.remove());
  }, duration);
}

async function safeFetch(url, options = {}) {
  try {
    const res = await fetch(url, options);
    if (!res.ok) {
      let errMsg = `Error ${res.status}`;
      try {
        const data = await res.json();
        errMsg = data.error || errMsg;
      } catch {}
      throw new Error(errMsg);
    }
    return await res.json();
  } catch (err) {
    showToast(err.message || 'Error de conexi√≥n con el servidor.', 'error');
    throw err;
  }
}

async function loadFavoritos() {

    favoritosContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#ccc;">Cargando favoritos...</div>';

    if (!token || !loggedInUser || !loggedInUser.id) {
        favoritosContainer.innerHTML = '<p style="color:#ff6b6b; text-align:center;">Error: No est√°s autenticado.</p>';
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
        return;
    }

    console.log('üîç User ID:', loggedInUser.id);
    console.log('üîç Token:', token ? 'Presente' : 'Faltante');

    let favoritosSeries = [];
    let favoritosPeliculas = [];

    try {
        console.log('üì° Haciendo fetch a series favoritas...');
        const resSeries = await fetch(`https://api.ultrafilm.online/favoritos?user_id=${loggedInUser.id}`, {
            headers: { 
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            cache: 'no-cache'
        });

        console.log('üì° Response series status:', resSeries.status);

        if (resSeries.status === 401) {
            showToast('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'error');
            localStorage.removeItem('jwt');
            localStorage.removeItem('loggedInUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }

        if (resSeries.ok) {
            favoritosSeries = await resSeries.json();
            console.log('üé¨ Series favoritas:', favoritosSeries);
            console.log('üé¨ Tipo de respuesta series:', typeof favoritosSeries);
            console.log('üé¨ Es array?', Array.isArray(favoritosSeries));
            console.log('üé¨ Longitud:', favoritosSeries.length);
        } else {
            console.error('‚ùå Error cargando series favoritas:', resSeries.status);
            const errorText = await resSeries.text();
            console.error('‚ùå Error details:', errorText);
        }
    } catch (e) {
        console.error('‚ùå Error en fetch de series:', e);
        favoritosSeries = [];
    }

    try {
        console.log('üì° Haciendo fetch a pel√≠culas favoritas...');
        const resPeliculas = await fetch(`https://api.ultrafilm.online/favoritos_peliculas?user_id=${loggedInUser.id}`, {
            headers: { 
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            cache: 'no-cache'
        });

        console.log('üì° Response pel√≠culas status:', resPeliculas.status);

        if (resPeliculas.status === 401) {
            showToast('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'error');
            localStorage.removeItem('jwt');
            localStorage.removeItem('loggedInUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }

        if (resPeliculas.ok) {
            favoritosPeliculas = await resPeliculas.json();
            console.log('üé¨ Pel√≠culas favoritas:', favoritosPeliculas);
            console.log('üé¨ Tipo de respuesta pel√≠culas:', typeof favoritosPeliculas);
            console.log('üé¨ Es array?', Array.isArray(favoritosPeliculas));
            console.log('üé¨ Longitud:', favoritosPeliculas.length);
        } else {
            console.error('‚ùå Error cargando pel√≠culas favoritas:', resPeliculas.status);
            const errorText = await resPeliculas.text();
            console.error('‚ùå Error details:', errorText);
        }
    } catch (e) {
        console.error('‚ùå Error en fetch de pel√≠culas:', e);
        favoritosPeliculas = [];
    }

    console.log('üìä Total series:', favoritosSeries.length);
    console.log('üìä Total pel√≠culas:', favoritosPeliculas.length);

    const favoritos = [...favoritosSeries, ...favoritosPeliculas];
    console.log('üìä Total favoritos combinados:', favoritos.length);

    if (!favoritos.length) {
        favoritosContainer.innerHTML = '<p style="color:#ccc; text-align:center;">No tienes favoritos a√∫n.</p>';
        console.log('‚ÑπÔ∏è No se encontraron favoritos');
        return;
    }

    console.log('üé® Renderizando favoritos...');
    favoritosContainer.innerHTML = favoritos.map(p => {
        const titulo = p.title || p.name || 'T√≠tulo no disponible';
        const tipo = p.name ? 'serie' : 'pelicula';
        const poster = p.poster_path ? 'https://image.tmdb.org/t/p/w500' + p.poster_path : 'https://via.placeholder.com/500x750?text=Sin+Imagen';

        console.log(`üé¨ Procesando: ${titulo} (${tipo})`);

        return `
            <article class="card" tabindex="0" aria-label="Favorito: ${titulo}" data-movie-id="${p.id}" data-type="${tipo}">
                <div class="card-media"><img src="${poster}" alt="Poster de ${titulo}" loading="lazy" /></div>
                <div class="card-body">
                    <h3 class="card-title">${titulo}</h3>
                    <p class="card-description">${p.overview ? (p.overview.slice(0, 120) + '...') : 'Sin descripci√≥n disponible.'}</p>
                </div>
                <div class="card-footer">
                    <button class="remove-fav-btn" data-id="${p.id}" data-tipo="${tipo}" aria-label="Quitar ${titulo} de favoritos">‚ùå Quitar</button>
                </div>
            </article>
        `;
    }).join('');

    console.log('üéØ A√±adiendo event listeners...');

    favoritosContainer.querySelectorAll('.remove-fav-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            e.preventDefault();

            const itemId = btn.getAttribute('data-id');
            const tipo = btn.getAttribute('data-tipo');
            const card = btn.closest('.card');
            const titulo = card.querySelector('.card-title').textContent;
            btn.disabled = true;

            try {
                await quitarFavorito(itemId, tipo);
                showToast(`Eliminaste "${titulo}" de favoritos.`, 'success');
                card.classList.add('removing');
                setTimeout(() => card.remove(), 250);
                if (!favoritosContainer.querySelector('.card')) {
                    favoritosContainer.innerHTML = '<p style="color:#ccc; text-align:center;">No tienes favoritos.</p>';
                }
            } catch (error) {
                btn.disabled = false;
                showToast('Error al eliminar de favoritos', 'error');
            }
        });
    });

    favoritosContainer.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', (e) => {
            if (e.target.closest('.remove-fav-btn')) {
                return;
            }

            const movieId = card.getAttribute('data-movie-id');
            const type = card.getAttribute('data-type');
            if (typeof openMovieModal === 'function') {
                openMovieModal(movieId, type);
            }
        });

        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const movieId = card.getAttribute('data-movie-id');
                const type = card.getAttribute('data-type');
                if (typeof openMovieModal === 'function') {
                    openMovieModal(movieId, type);
                }
            }
        });
    });

    console.log('‚úÖ Favoritos cargados correctamente');
}

async function quitarFavorito(itemId, tipo) {

    if (!token || !loggedInUser || !loggedInUser.id) {
        showToast('Error de autenticaci√≥n', 'error');
        throw new Error('No autenticado');
    }

    const endpoint = tipo === 'serie' 
        ? 'https://api.ultrafilm.online/favoritos' 
        : 'https://api.ultrafilm.online/favoritos_peliculas';

    const body = tipo === 'serie' 
        ? { user_id: loggedInUser.id, serie_id: Number(itemId) }
        : { user_id: loggedInUser.id, pelicula_id: Number(itemId) };

    const response = await fetch(endpoint, {
        method: 'DELETE',
        headers: { 
            'Content-Type': 'application/json', 
            'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify(body),
        cache: 'no-store'
    });

    if (response.status === 401) {
        showToast('Sesi√≥n expirada', 'error');
        localStorage.removeItem('jwt');
        localStorage.removeItem('loggedInUser');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
        throw new Error('Sesi√≥n expirada');
    }

    if (!response.ok) {
        throw new Error('Error al eliminar favorito');
    }

    return await response.json();
}

loadFavoritos();

const IMG_URL = 'https://image.tmdb.org/t/p/w500';

const modal = document.getElementById('movie-modal');
const modalBody = document.getElementById('modal-body');
const modalCloseBtn = document.getElementById('modal-close-btn');
let lastFocusedElement = null;

function attachCardHandlers() {
  document.querySelectorAll('#favoritos-container .card').forEach(card => {
    card.addEventListener('click', function(e) {
      if (e.target.closest('.remove-fav-btn')) return;
      const movieId = this.getAttribute('data-movie-id');
      const tipo = this.getAttribute('data-type');
      if (movieId) openMovieModal(movieId, tipo);
    });
    card.addEventListener('keydown', function(e) {
      if ((e.key === 'Enter' || e.key === ' ') && !e.target.closest('.remove-fav-btn')) {
        e.preventDefault();
        const movieId = this.getAttribute('data-movie-id');
        const tipo = this.getAttribute('data-type');
        if (movieId) openMovieModal(movieId, tipo);
      }
    });
  });
}

function openMovieModal(movieId, tipo) {
  lastFocusedElement = document.activeElement;
  showMovieDetails(movieId, tipo);
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  setTimeout(() => {
    modal.querySelector('.modal-content').focus();
  }, 100);
}

function closeMovieModal() {
  modal.style.display = 'none';
  document.body.style.overflow = '';
  modalBody.innerHTML = '';
  if (lastFocusedElement) lastFocusedElement.focus();
}

modalCloseBtn.addEventListener('click', closeMovieModal);
modal.addEventListener('click', (e) => {
  if (e.target === modal) closeMovieModal();
});
document.addEventListener('keydown', (e) => {
  if (modal.style.display === 'flex' && e.key === 'Escape') closeMovieModal();
});

async function showMovieDetails(id, tipo) {
  modalBody.innerHTML = '<div style="text-align:center;padding:40px 0;">Cargando...</div>';
  try {
    const media = tipo === 'serie' ? 'tv' : 'movie';
    const [details, reviewsData, videosData] = await Promise.all([
      window.tmdbFetch(`/${media}/${id}`, { language: 'es-ES' }),
      window.tmdbFetch(`/${media}/${id}/reviews`, { language: 'es-ES', page: 1 }),
      window.tmdbFetch(`/${media}/${id}/videos`, { language: 'es-ES' })
    ]);

    let trailer = null;
    if (videosData.results && videosData.results.length) {
      trailer = videosData.results.find(v => v.type === 'Trailer' && v.site === 'YouTube') || videosData.results.find(v => v.site === 'YouTube');
    }

    const reviews = (reviewsData.results || []).slice(0, 4);

    const title = details.title || details.name || 'T√≠tulo';
    const release = details.release_date || details.first_air_date || 'N/A';
    const runtime = details.runtime || (details.episode_run_time && details.episode_run_time[0]) || null;

    modalBody.innerHTML = `
      <div class="modal-movie-header">
        <img class="modal-movie-poster" src="${details.poster_path ? IMG_URL + details.poster_path : 'https://via.placeholder.com/500x750?text=No+Image'}" alt="Poster de ${title}" />
        <div class="modal-movie-info">
          <h2 class="modal-movie-title">${title}</h2>
          <div class="modal-movie-rating">‚≠ê ${details.vote_average ? details.vote_average.toFixed(1) : 'N/A'} / 10 (${details.vote_count || 0} votos)</div>
          <div class="modal-movie-overview">${details.overview || 'Sin descripci√≥n.'}</div>
          <div><b>G√©neros:</b> ${details.genres && details.genres.length ? details.genres.map(g => g.name).join(', ') : 'N/A'}</div>
          <div><b>Fecha de estreno:</b> ${release}</div>
          <div><b>Duraci√≥n:</b> ${runtime ? runtime + ' min' : 'N/A'}</div>
          <div style="margin-top:10px;">
            <b>Ver m√°s:</b>
            <a href="https://www.themoviedb.org/${media}/${details.id}" target="_blank" rel="noopener" style="color:#00b3ff;">TMDB</a>
            ${details.homepage ? `| <a href="${details.homepage}" target="_blank" rel="noopener" style="color:#00ff99;">Sitio Oficial</a>` : ''}
          </div>
        </div>
      </div>
      <div>
        <div class="modal-section-title">Rese√±as</div>
        <div class="modal-reviews">
          ${reviews.length ? reviews.map(r => `
            <div class="modal-review">
              <div class="modal-review-author">${r.author}</div>
              <div>${r.content.length > 300 ? r.content.slice(0,300) + '...' : r.content}</div>
            </div>
          `).join('') : '<div style="color:#aaa;">No hay rese√±as disponibles.</div>'}
        </div>
      </div>
      <div>
        <div class="modal-section-title">Trailer</div>
        <div class="modal-trailer">
          ${trailer ? `<iframe src="https://www.youtube.com/embed/${trailer.key}" allowfullscreen title="Trailer" loading="lazy"></iframe>` : '<div style="color:#aaa;">No hay trailer disponible.</div>'}
        </div>
      </div>
    `;
  } catch (e) {
    modalBody.innerHTML = '<div style="color:#e50914;text-align:center;padding:40px 0;">Error al cargar detalles.</div>';
  }
}
    </script>
</body>

</html>