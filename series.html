<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Series - UltraFilm</title>

    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#121212">
    <meta name="description" content="Explora series y programas de TV en UltraFilm. Encuentra tus series favoritas, organiza temporadas y descubre nuevos contenidos para maratonear.">
    <link rel="preconnect" href="https://api.ultrafilm.online">
    <link rel="preconnect" href="https://image.tmdb.org">
    <link rel="preconnect" href="https://www.themoviedb.org">
    <link rel="dns-prefetch" href="https://api.ultrafilm.online">
    <link rel="dns-prefetch" href="https://image.tmdb.org">

    <script>
        if ('serviceWorker' in navigator) {

      window.addEventListener('load', () => {

        navigator.serviceWorker.register('sw.js');

      });

    }

    </script>
</head>

<body>

    <header>üì∫ Series Populares</header>

    <nav>

        <a href="dash.html">Inicio</a>

        <a href="peliculas.html">Pel√≠culas</a>

        <a href="series.html" aria-current="page">Series</a>

        <a href="favoritos.html">Favoritos</a>

        <a href="guardados.html" aria-current="page" style="background:#333;color:#eee;font-weight:bold;">Ver m√°s
            tarde</a>

        <button id="logout-btn" class="btn-logout">Cerrar sesi√≥n</button>

    </nav>

    <main>

        <input type="text" id="search-input" placeholder="Buscar series..." aria-label="Buscar series por t√≠tulo" style="width:100%;max-width:300px;font-size:1rem;padding:8px 12px;margin-bottom:25px;border-radius:6px;border:none;background-color:#222;color:#eee;" />

        <select id="genre-select" aria-label="Filtrar por g√©nero">

      <option value="0">Todos los g√©neros</option>

    </select>

        <select id="sort-select" aria-label="Ordenar por" style="width:100%;max-width:180px;font-size:1rem;padding:8px 12px;margin-bottom:25px;border-radius:6px;border:none;background-color:#222;color:#eee;margin-left:10px;">

      <option value="popularity.desc">M√°s populares</option>

      <option value="popularity.asc">Menos populares</option>

      <option value="first_air_date.desc">M√°s nuevas</option>

      <option value="first_air_date.asc">M√°s antiguas</option>

      <option value="vote_average.desc">Mejor puntuadas</option>

      <option value="vote_average.asc">Peor puntuadas</option>

      <option value="original_name.asc">T√≠tulo (A-Z)</option>

      <option value="original_name.desc">T√≠tulo (Z-A)</option>

    </select>

        <div id="series-container" aria-live="polite" aria-relevant="additions"></div>

        <div class="pagination">

            <button id="prev-page" disabled>Anterior</button>

            <span id="page-indicator">P√°gina 1</span>

            <button id="next-page">Siguiente</button>

        </div>

        <div id="serie-modal" class="modal" style="display:none;">

            <div class="modal-content" tabindex="0">

                <button class="modal-close" id="serie-modal-close-btn" aria-label="Cerrar modal">&times;</button>

                <div id="serie-modal-body">

                </div>

            </div>

        </div>

    </main>

    <footer>¬© 2025 UltraFilm Cine & Series. Todos los derechos reservados.</footer>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script src="/js/tmdb.js"></script>
    <script>

const IMG_URL_SMALL = 'https://image.tmdb.org/t/p/w300';   

const IMG_URL_MEDIUM = 'https://image.tmdb.org/t/p/w400';  

const IMG_URL_LARGE = 'https://image.tmdb.org/t/p/w500';   

const IMG_URL_ORIGINAL = 'https://image.tmdb.org/t/p/original'; 

const PLACEHOLDER_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMjIyIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2NjYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';

function getOptimizedImageUrl(posterPath, size = 'small') {
    if (!posterPath) return PLACEHOLDER_IMAGE;

    const sizes = {
        'small': IMG_URL_SMALL,    

        'medium': IMG_URL_MEDIUM,  

        'large': IMG_URL_LARGE,    

        'original': IMG_URL_ORIGINAL
    };

    return sizes[size] + posterPath;
}

let currentPage = 1;

let totalPages = 1;

let currentGenre = 0;

let currentSearchQuery = '';

let currentSort = 'popularity.desc';

let genres = [];

let series = [];

const genreSelect = document.getElementById('genre-select');

const sortSelect = document.getElementById('sort-select');

const seriesContainer = document.getElementById('series-container');

const searchInput = document.getElementById('search-input');

const prevPageBtn = document.getElementById('prev-page');

const nextPageBtn = document.getElementById('next-page');

const pageIndicator = document.getElementById('page-indicator');

const token = localStorage.getItem('jwt');

const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

if (!token) {

  alert('No hay JWT en localStorage');

  localStorage.removeItem('jwt');

  localStorage.removeItem('loggedInUser');

  window.location.href = 'login.html';

}

if (!loggedInUser || !loggedInUser.id) {

  alert('No hay usuario en localStorage');

  localStorage.removeItem('jwt');

  localStorage.removeItem('loggedInUser');

  window.location.href = 'login.html';

}

let searchTimeout;

searchInput.addEventListener('input', () => {

  clearTimeout(searchTimeout);

  searchTimeout = setTimeout(() => {

    currentSearchQuery = searchInput.value.trim();

    currentPage = 1;

    fetchSeries();

  }, 300);

});

prevPageBtn.addEventListener('click', () => {

  if (currentPage > 1) {

    currentPage--;

    fetchSeries();

  }

});

nextPageBtn.addEventListener('click', () => {

  if (currentPage < totalPages) {

    currentPage++;

    fetchSeries();

  }

});

genreSelect.addEventListener('change', () => {

  currentGenre = parseInt(genreSelect.value);

  currentPage = 1;

  fetchSeries();

});

sortSelect.addEventListener('change', () => {

  currentSort = sortSelect.value;

  currentPage = 1;

  fetchSeries();

});

async function fetchGenres() {

  try {

    const data = await tmdbFetch('/genre/tv/list', { language: 'es-ES' });

    genres = data.genres || [];

    populateGenreSelect();

  } catch (e) {

    showToast('Error cargando g√©neros', 'error');

  }

}

function populateGenreSelect() {

  genres.forEach(genre => {

    const option = document.createElement('option');

    option.value = genre.id;

    option.textContent = genre.name;

    genreSelect.appendChild(option);

  });

}

async function fetchSeries() {

const startTime = performance.now();

  try {

    let data;
    console.log('üïê Iniciando carga de series...');

    if (currentSearchQuery) {
      const searchStart = performance.now();
      data = await tmdbFetch('/search/tv', { 
        language: 'es-ES', 
        query: currentSearchQuery, 
        page: currentPage 
      });
      console.log(`üîç B√∫squeda series: ${(performance.now() - searchStart).toFixed(0)}ms`);

      let results = data.results || [];

      if (currentGenre && currentGenre != 0) {

        results = results.filter(s => (s.genre_ids || []).includes(currentGenre));

      }

      results = sortSearchResults(results, currentSort);

      series = results;

      totalPages = data.total_pages || 1;

    } else if (currentGenre && currentGenre != 0) {

      data = await tmdbFetch('/discover/tv', {
        language: 'es-ES',
        sort_by: currentSort,
        page: currentPage,
        with_genres: currentGenre
      });

      series = data.results || [];

      totalPages = data.total_pages || 1;

    } else {

      data = await tmdbFetch('/discover/tv', {
        language: 'es-ES',
        sort_by: currentSort,
        page: currentPage
      });

      series = data.results || [];

      totalPages = data.total_pages || 1;

    }

    renderSeries();

    updatePaginationControls();

  } catch (e) {

    showToast('Error al cargar series', 'error');

    seriesContainer.innerHTML = '<p style="color:#e50914;text-align:center;">Error al cargar series.</p>';

  }

}

function sortSearchResults(results, sortBy) {

  const [field, dir] = sortBy.split('.');

  return results.slice().sort((a, b) => {

    let va, vb;

    switch (field) {

      case 'popularity':

        va = a.popularity; vb = b.popularity; break;

      case 'first_air_date':

        va = a.first_air_date || ''; vb = b.first_air_date || ''; break;

      case 'vote_average':

        va = a.vote_average; vb = b.vote_average; break;

      case 'original_name':

        va = (a.original_name || '').toLowerCase(); vb = (b.original_name || '').toLowerCase(); break;

      default:

        va = 0; vb = 0;

    }

    if (va < vb) return dir === 'asc' ? -1 : 1;

    if (va > vb) return dir === 'asc' ? 1 : -1;

    return 0;

  });

}

let favoritos = [];
let favoritosCargados = false;

async function fetchFavoritos(force = false) {
  if (!loggedInUser || !loggedInUser.id) {
    favoritos = [];
    return favoritos;
  }

  if (favoritosCargados && !force) return favoritos;

  try {

    const res = await fetch(`https://api.ultrafilm.online/favoritos?user_id=${loggedInUser.id}&tipo=series`, {
      headers: { 'Authorization': 'Bearer ' + token },
      cache: 'no-cache'
    });

    if (!res.ok) throw new Error('Error cargando favoritos');

    favoritos = await res.json();
    favoritosCargados = true;
    console.log('Favoritos series cargados:', favoritos.length);
  } catch (e) {
    console.error('Error fetchFavoritos series:', e);
    favoritos = [];
  }
}

function esFavorito(id) {
  return favoritos.some(fav => fav.id === id);
}

async function toggleFavorito(serie) {
  if (!loggedInUser || !loggedInUser.id) return;

  const esActualmenteFavorito = esFavorito(serie.id);

  try {
    if (esActualmenteFavorito) {

      const response = await safeFetch('https://api.ultrafilm.online/favoritos', {
        method: 'DELETE',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify({ 
          user_id: loggedInUser.id, 
          serie_id: serie.id,
          tipo: 'series'  

        })
      });

      favoritos = favoritos.filter(f => f.id !== serie.id);
      showToast(`Eliminaste "${serie.name}" de favoritos.`, 'error');

    } else {

      const response = await safeFetch('https://api.ultrafilm.online/favoritos', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify({ 
          user_id: loggedInUser.id, 
          serie: serie,
          tipo: 'series'  

        })
      });

      favoritos.push(serie);
      showToast(`Agregaste "${serie.name}" a favoritos.`, 'success');
    }

    favoritosCargados = true;
    renderSeries();

  } catch (error) {
    console.error('Error en toggleFavorito series:', error);
    favoritosCargados = false;
    await fetchFavoritos(true);
    renderSeries();
  }
}

let guardados = [];
let guardadosCargados = false;

async function fetchGuardados(force = false) {
  if (!loggedInUser || !loggedInUser.id) {
    guardados = [];
    return guardados;
  }

  if (guardadosCargados && !force) return guardados;

  try {

    const res = await fetch(`https://api.ultrafilm.online/guardados?user_id=${loggedInUser.id}&tipo=series`, {
      headers: { 'Authorization': 'Bearer ' + token },
      cache: 'no-cache'
    });

    if (!res.ok) throw new Error('Error cargando guardados');

    guardados = await res.json();
    guardadosCargados = true;
    console.log('Guardados series cargados:', guardados.length);
  } catch (e) {
    console.error('Error fetchGuardados series:', e);
    guardados = [];
  }
}

function estaGuardado(id) {
  return guardados.some(g => g.id === id);
}

async function toggleGuardado(serie) {
  if (!loggedInUser || !loggedInUser.id) return;

  const esActualmenteGuardado = estaGuardado(serie.id);

  try {
    if (esActualmenteGuardado) {

      const response = await safeFetch('https://api.ultrafilm.online/guardados', {
        method: 'DELETE',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify({ 
          user_id: loggedInUser.id, 
          serie_id: serie.id,
          tipo: 'series'  

        })
      });

      guardados = guardados.filter(g => g.id !== serie.id);
      showToast(`Eliminaste "${serie.name}" de ver m√°s tarde.`, 'error');

    } else {

      const response = await safeFetch('https://api.ultrafilm.online/guardados', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify({ 
          user_id: loggedInUser.id, 
          serie: serie,
          tipo: 'series'  

        })
      });

      guardados.push(serie);
      showToast(`Guardaste "${serie.name}" para ver m√°s tarde.`, 'success');
    }

    guardadosCargados = true;
    renderSeries();

  } catch (error) {
    console.error('Error en toggleGuardado series:', error);
    guardadosCargados = false;
    await fetchGuardados(true);
    renderSeries();
  }
}

    searchInput.addEventListener('input', () => {

      clearTimeout(searchTimeout);

      searchTimeout = setTimeout(() => {

        currentSearchQuery = searchInput.value.trim();

        fetchSeries(parseInt(genreSelect.value), 1);

      }, 300);

    });

    sortSelect.addEventListener('change', () => {

      currentSort = sortSelect.value;

      fetchSeries(parseInt(genreSelect.value), 1);

    });

    genreSelect.addEventListener('change', () => {

      currentGenre = parseInt(genreSelect.value);

      fetchSeries(currentGenre, 1);

    });

    const serieModal = document.getElementById('serie-modal');

    const serieModalBody = document.getElementById('serie-modal-body');

    const serieModalCloseBtn = document.getElementById('serie-modal-close-btn');

    function openSerieModal(serieId) {

      showSerieDetails(serieId);

      serieModal.style.display = 'flex';

      document.body.style.overflow = 'hidden';

      setTimeout(() => {

        serieModal.querySelector('.modal-content').focus();

      }, 100);

    }

    function closeSerieModal() {

      serieModal.style.display = 'none';

      document.body.style.overflow = '';

      serieModalBody.innerHTML = '';

    }

    serieModalCloseBtn.addEventListener('click', closeSerieModal);

    serieModal.addEventListener('click', (e) => {

      if (e.target === serieModal) closeSerieModal();

    });

    document.addEventListener('keydown', (e) => {

      if (serieModal.style.display === 'flex' && e.key === 'Escape') closeSerieModal();

    });

    async function showSerieDetails(serieId) {

      serieModalBody.innerHTML = '<div style="text-align:center;padding:40px 0;">Cargando...</div>';

      try {

        const [details, reviewsData, videosData] = await Promise.all([

          tmdbFetch(`/tv/${serieId}`, { language: 'es-ES' }),

          tmdbFetch(`/tv/${serieId}/reviews`, { language: 'es-ES', page: 1 }),

          tmdbFetch(`/tv/${serieId}/videos`, { language: 'es-ES' })

        ]);

        let trailer = null;

        if (videosData.results && videosData.results.length) {

          trailer = videosData.results.find(v => v.type === 'Trailer' && v.site === 'YouTube') ||

                    videosData.results.find(v => v.site === 'YouTube');

        }

        const reviews = (reviewsData.results || []).slice(0, 4);

        serieModalBody.innerHTML = `

          <div class="modal-movie-header">

<img class="modal-movie-poster" 
     src="${getOptimizedImageUrl(details.poster_path, 'large')}" 
     alt="Poster de ${details.name}" 
     loading="eager" />

            <div class="modal-movie-info">

              <h2 class="modal-movie-title">${details.name}</h2>

              <div class="modal-movie-rating">‚≠ê ${details.vote_average ? details.vote_average.toFixed(1) : 'N/A'} / 10 (${details.vote_count || 0} votos)</div>

              <div class="modal-movie-overview">${details.overview || 'Sin descripci√≥n.'}</div>

              <div><b>G√©neros:</b> ${details.genres && details.genres.length ? details.genres.map(g => g.name).join(', ') : 'N/A'}</div>

              <div><b>Fecha de estreno:</b> ${details.first_air_date || 'N/A'}</div>

              <div><b>Temporadas:</b> ${details.number_of_seasons || 'N/A'} | <b>Episodios:</b> ${details.number_of_episodes || 'N/A'}</div>

              <div style="margin-top:10px;">

                <b>Ver m√°s:</b>

                <a href="https://www.themoviedb.org/tv/${details.id}" target="_blank" rel="noopener" style="color:#00b3ff;">TMDB</a>

                ${details.homepage ? `| <a href="${details.homepage}" target="_blank" rel="noopener" style="color:#00ff99;">Sitio Oficial</a>` : ''}

              </div>

            </div>

          </div>

          <div>

            <div class="modal-section-title">Rese√±as</div>

            <div class="modal-reviews">

              ${reviews.length ? reviews.map(r => `

                <div class="modal-review">

                  <div class="modal-review-author">${r.author}</div>

                  <div>${r.content.length > 300 ? r.content.slice(0, 300) + '...' : r.content}</div>

                </div>

              `).join('') : '<div style="color:#aaa;">No hay rese√±as disponibles.</div>'}

            </div>

          </div>

          <div>

            <div class="modal-section-title">Trailer</div>

            <div class="modal-trailer">

              ${trailer ? `<iframe src="https://www.youtube.com/embed/${trailer.key}" allowfullscreen title="Trailer"></iframe>` : '<div style="color:#aaa;">No hay trailer disponible.</div>'}

            </div>

          </div>

        `;

      } catch (e) {

        serieModalBody.innerHTML = '<div style="color:#e50914;text-align:center;padding:40px 0;">Error al cargar detalles.</div>';

      }

    }

async function renderSeries() {
    if (!series.length) {
        seriesContainer.innerHTML = '<p style="color:#ccc; text-align:center;">No se encontraron series.</p>';
        return;
    }

    renderSeriesCardsImmediately();

    loadAndUpdateSeriesStates();
}

function renderSeriesCardsImmediately() {
    seriesContainer.innerHTML = series.map(s => {
        return `
          <article class="card" tabindex="0" aria-label="Serie: ${s.name}" data-serie-id="${s.id}">
            <button class="fav-star-btn" aria-pressed="false" aria-label="Agregar a favoritos" data-id="${s.id}">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#eee" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path stroke-linejoin="round" stroke-linecap="round" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
              </svg>
            </button>
            <button class="bookmark-btn" aria-pressed="false" aria-label="Guardar para ver m√°s tarde" data-id="${s.id}" tabindex="0" style="position:absolute;top:10px;left:10px;background:transparent;border:none;cursor:pointer;padding:0;z-index:2;display:flex;align-items:center;justify-content:center;">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#eee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" fill="none"/>
              </svg>
            </button>
            <img loading="lazy" 
                 src="${getOptimizedImageUrl(s.poster_path, 'small')}" 
                 alt="Poster de ${s.name}"
                 data-src-large="${getOptimizedImageUrl(s.poster_path, 'large')}"
                 style="opacity: 0; transition: opacity 0.3s ease-in-out;"
                 onload="this.style.opacity='1'" />
            <div class="card-content">
              <h3 class="card-title">${s.name}</h3>
              <p class="card-description">${s.overview ? s.overview.slice(0, 100) + (s.overview.length > 100 ? '...' : '') : 'Sin descripci√≥n.'}</p>
            </div>
          </article>
        `;
    }).join('');

    document.querySelectorAll('.fav-star-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const serieId = parseInt(btn.getAttribute('data-id'));
            const serie = series.find(s => s.id === serieId);
            if (serie) toggleFavorito(serie);
        });
    });

    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const serieId = parseInt(btn.getAttribute('data-id'));
            const serie = series.find(s => s.id === serieId);
            if (serie) toggleGuardado(serie);
        });
    });

    document.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.closest('.fav-star-btn') || e.target.closest('.bookmark-btn')) return;
            const serieId = this.getAttribute('data-serie-id');
            openSerieModal(serieId);
        });

        card.addEventListener('keydown', function(e) {
            if ((e.key === 'Enter' || e.key === ' ') && !e.target.closest('.fav-star-btn') && !e.target.closest('.bookmark-btn')) {
                e.preventDefault();
                const serieId = this.getAttribute('data-serie-id');
                openSerieModal(serieId);
            }
        });
    });
}

async function loadAndUpdateSeriesStates() {
    try {
        await Promise.all([fetchFavoritos(), fetchGuardados()]);

        document.querySelectorAll('.fav-star-btn').forEach(btn => {
            const serieId = parseInt(btn.getAttribute('data-id'));
            const esFav = esFavorito(serieId);

            if (esFav) {
                btn.classList.add('favorito');
                btn.setAttribute('aria-pressed', 'true');
                btn.querySelector('svg').setAttribute('fill', '#f1c40f');
                btn.querySelector('svg').setAttribute('stroke', '#f1c40f');
                btn.setAttribute('aria-label', 'Eliminar de favoritos');
            }
        });

        document.querySelectorAll('.bookmark-btn').forEach(btn => {
            const serieId = parseInt(btn.getAttribute('data-id'));
            const estaGuard = estaGuardado(serieId);

            if (estaGuard) {
                btn.classList.add('guardado');
                btn.setAttribute('aria-pressed', 'true');
                btn.querySelector('svg').setAttribute('stroke', '#00b3ff');
                btn.querySelector('path').setAttribute('fill', '#00b3ff');
                btn.setAttribute('aria-label', 'Quitar de ver m√°s tarde');
            }
        });

    } catch (error) {
        console.error('Error actualizando estados series:', error);
    }
}

function updatePaginationControls() {
    pageIndicator.textContent = `P√°gina ${currentPage} de ${totalPages}`;
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
}

function showToast(message, type = 'info', duration = 3500) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.classList.add('hide');
        toast.addEventListener('transitionend', () => toast.remove());
    }, duration);
}

async function safeFetch(url, options = {}) {
    options.headers = options.headers || {};

    if (url.startsWith('https://api.ultrafilm.online')) {
        options.headers['Authorization'] = 'Bearer ' + token;
    }

    if (!options.cache) {
        options.cache = 'no-cache';
    }

    try {
        const res = await fetch(url, options);

        if (!res.ok) {
            let errMsg = `Error ${res.status}`;
            try {
                const data = await res.json();
                errMsg = data.error || errMsg;
            } catch {}
            throw new Error(errMsg);
        }

        return await res.json();
    } catch (err) {
        console.error('Error en safeFetch:', err);
        showToast(err.message || 'Error de conexi√≥n con el servidor.', 'error');
        throw err;
    }
}
function openSerieModal(serieId) {
    showSerieDetails(serieId);
    serieModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
        serieModal.querySelector('.modal-content').focus();
    }, 100);
}

function closeSerieModal() {
    serieModal.style.display = 'none';
    document.body.style.overflow = '';
    serieModalBody.innerHTML = '';
}

serieModalCloseBtn.addEventListener('click', closeSerieModal);
serieModal.addEventListener('click', (e) => {
    if (e.target === serieModal) closeSerieModal();
});
document.addEventListener('keydown', (e) => {
    if (serieModal.style.display === 'flex' && e.key === 'Escape') closeSerieModal();
});

async function showSerieDetails(serieId) {
    serieModalBody.innerHTML = '<div style="text-align:center;padding:40px 0;">Cargando...</div>';
    try {

        const [details, reviewsData, videosData] = await Promise.all([
            tmdbFetch(`/tv/${serieId}`, { language: 'es-ES' }),
            tmdbFetch(`/tv/${serieId}/reviews`, { language: 'es-ES', page: 1 }),
            tmdbFetch(`/tv/${serieId}/videos`, { language: 'es-ES' })
        ]);

        let trailer = null;
        if (videosData.results && videosData.results.length) {
            trailer = videosData.results.find(v => v.type === 'Trailer' && v.site === 'YouTube') ||
                    videosData.results.find(v => v.site === 'YouTube');
        }

        const reviews = (reviewsData.results || []).slice(0, 4);

        serieModalBody.innerHTML = `
          <div class="modal-movie-header">
            <img class="modal-movie-poster" 
                 src="${getOptimizedImageUrl(details.poster_path, 'large')}" 
                 alt="Poster de ${details.name}" 
                 loading="eager" />
            <div class="modal-movie-info">
              <h2 class="modal-movie-title">${details.name}</h2>
              <div class="modal-movie-rating">‚≠ê ${details.vote_average ? details.vote_average.toFixed(1) : 'N/A'} / 10 (${details.vote_count || 0} votos)</div>
              <div class="modal-movie-overview">${details.overview || 'Sin descripci√≥n.'}</div>
              <div><b>G√©neros:</b> ${details.genres && details.genres.length ? details.genres.map(g => g.name).join(', ') : 'N/A'}</div>
              <div><b>Fecha de estreno:</b> ${details.first_air_date || 'N/A'}</div>
              <div><b>Temporadas:</b> ${details.number_of_seasons || 'N/A'} | <b>Episodios:</b> ${details.number_of_episodes || 'N/A'}</div>
              <div style="margin-top:10px;">
                <b>Ver m√°s:</b>
                <a href="https://www.themoviedb.org/tv/${details.id}" target="_blank" rel="noopener" style="color:#00b3ff;">TMDB</a>
                ${details.homepage ? `| <a href="${details.homepage}" target="_blank" rel="noopener" style="color:#00ff99;">Sitio Oficial</a>` : ''}
              </div>
            </div>
          </div>
          <div>
            <div class="modal-section-title">Rese√±as</div>
            <div class="modal-reviews">
              ${reviews.length ? reviews.map(r => `
                <div class="modal-review">
                  <div class="modal-review-author">${r.author}</div>
                  <div>${r.content.length > 300 ? r.content.slice(0, 300) + '...' : r.content}</div>
                </div>
              `).join('') : '<div style="color:#aaa;">No hay rese√±as disponibles.</div>'}
            </div>
          </div>
          <div>
            <div class="modal-section-title">Trailer</div>
            <div class="modal-trailer">
              ${trailer ? `<iframe src="https://www.youtube.com/embed/${trailer.key}" allowfullscreen title="Trailer"></iframe>` : '<div style="color:#aaa;">No hay trailer disponible.</div>'}
            </div>
          </div>
        `;
    } catch (e) {
        serieModalBody.innerHTML = '<div style="color:#e50914;text-align:center;padding:40px 0;">Error al cargar detalles.</div>';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    fetchGenres().then(async () => {
        await fetchSeries();
    });
});
    </script>

    <script src="/js/maintenance.js" defer></script>

</body>

</html>